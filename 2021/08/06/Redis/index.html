<!-- build time:Mon Aug 09 2021 21:58:24 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="QWQ" href="https://ling-yunchi.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="QWQ" href="https://ling-yunchi.github.io/atom.xml"><link rel="alternate" type="application/json" title="QWQ" href="https://ling-yunchi.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://ling-yunchi.github.io/2021/08/06/Redis/"><title>Redis | Ling Yunchi = QWQ</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Redis</h1><div class="meta"><span class="item" title="创建时间：2021-08-06 09:00:22"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-06T09:00:22+08:00">2021-08-06</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Ling Yunchi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipewr8iypj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipevgoki5j20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicm0n457cj20zk0m8e81.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giciub8ja1j20zk0m81ky.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclg5ms2rj20zk0m8u0x.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://ling-yunchi.github.io/2021/08/06/Redis/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Ling yunchi"><meta itemprop="description" content=", qwqqqq"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="QWQ"></span><div class="body md" itemprop="articleBody"><h1 id="redis"><a class="anchor" href="#redis">#</a> Redis</h1><h2 id="nosql"><a class="anchor" href="#nosql">#</a> Nosql</h2><h3 id="为什么要用nosql"><a class="anchor" href="#为什么要用nosql">#</a> 为什么要用 Nosql</h3><blockquote><p>单机 mysql 的年代</p></blockquote><p>当时更多使用静态网页，服务器压力很小</p><pre><code>APP ==&gt; DAL ==&gt; Mysql
</code></pre><p>网站的瓶颈在于:</p><ul><li>数据量太大，存不下</li><li>数据的索引 (B+ Tree), 一个机器的内存放不下</li><li>访问量过高 (读写混合), 服务器无法承受</li></ul><blockquote><p>Memcached (缓存) + MySQL + 垂直拆分 (读写分离)</p></blockquote><p>网站 80% 以上的操作都是在读数据，每次读取都去数据库里查询很麻烦，为了减轻数据库压力，我们将查询出来的结果保存在缓存中，使用缓存来保证效率.</p><p>发展过程︰优化数据结构和索引 --&gt; 文件缓存 (IO) ---&gt; Memcached (当时最热门的技术！)</p><pre><code>			     ==&gt; Mysql 1 (read) &lt;==
			     ||                  || Synchronize(同步)
APP ==&gt; DAL ==&gt; Cache ============&gt; Mysql 2 (write)
			     ||                  ||
			     ==&gt; Mysql 3 (read) &lt;==
</code></pre><blockquote><p>分库分表 + 水平拆分 + MySQL 集群</p></blockquote><p><mark>本质：数据库 (读，写)</mark></p><p>早先年 MyISAM: 表锁，查询时锁定被查询的整个表，高并发下效率很差！</p><p>Innodb: 行锁</p><p>使用分库分表来解决写入的压力.</p><p>MySQL 的集群很好解决了那时的需求！</p><p><img data-src="/image-20210806093656272.png" alt="image-20210806093656272"></p><blockquote><p>现在</p></blockquote><p>数据量大，变化很快 (位置信息，音乐，热榜)</p><p>MySQL 等关系数据库不够用了！</p><p>MySQL 存储大文件时，表很大，效率就会降低。需要一种数据库来专门处理这种数据，使表变小！</p><p><strong>目前一个基本互联网项目的架构:</strong></p><p><img data-src="/image-20210806100003334.png" alt="image-20210806100003334"></p><blockquote><p>为什么要用 NoSQL!</p></blockquote><p>用户的个人信息，社交网络，地理位置。用户自己产生的数据，用户日志等等爆发试增长！</p><p>而 NoSQL 可以很好的处理以上状况！</p><h3 id="什么是nosql"><a class="anchor" href="#什么是nosql">#</a> 什么是 NoSQL</h3><blockquote><p><strong><mark>NoSQL (Not Only SQL)</mark></strong></p></blockquote><p>泛指非关系型数据库！</p><p>很多的数据类型用户的个人信息，社交网络，地理位置。这些数据类型的存储不需要一个固定的格式！不需要多月的操作就可以横向扩展的！ <code>Map&lt;String, Object&gt;</code> 使用键值对来控制！</p><blockquote><p>NoSQL 特点</p></blockquote><p>解耦</p><ol><li><p>方便扩展 (数据之间没用关系，很好扩展！)</p></li><li><p>大数据量高性能 (Redis 一秒写 8 万次，读取 11 万，NoSQL 的缓存记录级，是一种细粒度的缓存，性能较高)</p></li><li><p>数据类型是多样型的 (不需要实现设计数据库！随取随用！)</p></li><li><p>传统的 RDBMS 和 NoSQL</p><ul><li><p>RDBMS (关系型数据库)</p><ul><li>结构化组织</li></ul></li><li><p>SQL</p></li><li><p>数据和关系都存在单独的表中</p></li><li><p>操作数据操作语言，数据定义语言</p></li><li><p>严格的一致性</p></li><li><p>基础的事务</p></li><li><p>NoSQL</p><ul><li><p>不仅仅是数据</p></li><li><p>没有固定的查询语言</p></li><li><p>键值对存储，列存储，文档存储，图形数据库 (社交关系)</p></li><li><p>最终一致性</p></li><li><p>CAP 定理 和 BASE (异地多活)</p><blockquote><p>CAP 定理指出，在一个分布式系统中，对于一致性、可用性、分区容错这三个特性，不可能同时满足，而是必须有所舍弃。我们设计分布式系统时，必须在三者之间（尤其是一致性和可用性之间）有所取舍和平衡。</p></blockquote></li></ul></li></ul></li></ol><blockquote><p>大数据时代的 3V 与 3 高</p><ul><li><p>海量 Volume</p></li><li><p>多样 Variety</p></li><li><p>实时 Velocity</p></li><li><p>高并发</p></li><li><p>高可扩</p></li><li><p>高性能</p></li></ul></blockquote><p>真正在公司中的实践: RDBMS + NoSQL 一起使用</p><h3 id="nosql的四大分类"><a class="anchor" href="#nosql的四大分类">#</a> NoSQL 的四大分类</h3><p><strong>KV 键值对:</strong></p><ul><li>新浪：Redis</li><li>美团：Redis+Tair</li><li>阿里，百度：Redis+memcache</li></ul><p><strong>文档型数据库:</strong></p><ul><li>MongoDB<ul><li>MongoDB 是一个基于分布式文件存储的数据库，C++ 编写，主要用来处理大量的文档！</li><li>MongoDB 是一个介于关系型数据库和非关系型数据中中间的产品！MongoDB 是<strong>非关系型数据库</strong>中<strong>功能最丰富</strong>，最<strong>像关系型数据库</strong>的！</li></ul></li><li>ConthDB</li></ul><p><strong>列存储数据库:</strong></p><ul><li>HBase</li><li>分布式文件系统</li></ul><p><strong>图关系数据库:</strong></p><ul><li>用于存 &quot;图&quot; 这种数据结构的数据库</li><li>存放关系</li><li>Neo4j, InfoGrid</li></ul><h2 id="redis入门"><a class="anchor" href="#redis入门">#</a> Redis 入门</h2><blockquote><p>什么是 Redis</p></blockquote><p>Redis（<mark>Re</mark>mote <mark>Di</mark>ctionary <mark>S</mark>erver )，即<strong>远程字典服务</strong>！</p><p>是一个开源的使用 ANSI C 语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value 数据库，并提供多种语言的 API。</p><blockquote><p>redis 能干嘛？</p></blockquote><ol><li><p>内存存储、持久化，内存中是断电即失、所以说持久化很重要（rdb、aof）</p></li><li><p>效率高，可以用于高速缓存</p></li><li><p>发布订阅系统</p></li><li><p>地图信息分析</p></li><li><p>计时器、计数器</p><p>......</p></li></ol><blockquote><p>特性</p></blockquote><ol><li><p>多样的数据类型</p></li><li><p>持久化</p></li><li><p>集群</p></li><li><p>事务</p><p>......</p></li></ol><h3 id="redis安装"><a class="anchor" href="#redis安装">#</a> redis 安装</h3><p>推荐使用 linux 版本</p><h3 id="redis启动与链接与停止"><a class="anchor" href="#redis启动与链接与停止">#</a> redis 启动与链接与停止</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 首先要将 redis-server 修改为后台运行</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 将 redis.conf 中的 daemonize no 修改为 daemonize yes </span></pre></td></tr><tr><td data-num="3"></td><td><pre>	daemonize no <span class="token operator">=</span><span class="token operator">></span> <span class="token function">yes</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># ==============================================</span></pre></td></tr><tr><td data-num="5"></td><td><pre>redis-server <span class="token punctuation">[</span>redis.conf<span class="token punctuation">]</span> <span class="token comment"># 用 redis.conf 配置文件启动 redis-server</span></pre></td></tr><tr><td data-num="6"></td><td><pre>redis-cli -p <span class="token number">6379</span> <span class="token comment"># 使用命令行交互工具链接 redis-server, 默认端口号为 6379</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">exit</span> <span class="token comment"># 退出 redis 命令行交互工具</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token function">shutdown</span> <span class="token comment"># 关闭当前链接的 redis-server</span></pre></td></tr></table></figure><h3 id="测试性能"><a class="anchor" href="#测试性能">#</a> 测试性能</h3><p><strong>redis-benchmark</strong> 是一个官方自带的压力测试工具</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWRpcy9yZWRpcy1iZW5jaG1hcmtzLmh0bWw=">Redis 性能测试 | 菜鸟教程</span></p><h3 id="基础知识"><a class="anchor" href="#基础知识">#</a> 基础知识</h3><p>redis 默认有 16 个数据库</p><p>默认使用第 0 个数据库</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SELECT <span class="token number">1</span> <span class="token comment"># 切换数据库</span></pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">></span> DBSIZE <span class="token comment"># 查看数据库大小</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name qwq <span class="token comment"># 设定键值对</span></pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get name <span class="token comment"># 取出键对应的值</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token string">"qwq"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys * <span class="token comment"># 查看当前数据库所有 key</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> flushall <span class="token comment"># 清空所有数据库</span></pre></td></tr><tr><td data-num="12"></td><td><pre>OK</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> flushdb <span class="token comment"># 清空当前数据库</span></pre></td></tr><tr><td data-num="14"></td><td><pre>OK</pre></td></tr></table></figure><blockquote><p>redis 是单线程的</p></blockquote><p>Redis 是很快的，官方表示，Redis 是基于内存操作，CPU 不是 Redis 性能瓶颈，Redis 的瓶颈是根据机器的内存和网络带宽，既然可以使用单线程来实现，就使用单线程了！</p><p>Redis 是 C 语言写的，官方提供的数据为 100000 + 的 QPS，完全不比同样是使用 key-value 的 Memecache 差</p><p><strong>Redis 为什么单线程这么快？</strong></p><p>核心: redis 是将所有的数据全部放在内存中的，所以说使用单线程去操作效率就是最高的，多线程 (CPU 上下文会切换∶耗时的操作！！！), 对于内存系统来说，如果没有上下文切换时的效率就是最高的！</p><h2 id="五大数据类型"><a class="anchor" href="#五大数据类型">#</a> 五大数据类型</h2><p>Redis 是一个开源（BSD 许可) 的，内存中的数据结构存储系统，它可以用作<strong>数据库</strong>、<strong>缓存</strong>和<strong>消息中间件 MQ</strong>。它支持多种类型的数据结构，如字符串 (strings)，散列 ( hashes )，列表 ( lists )，集合 ( sets )，有序集合 ( sorted sets）与范围查询，bitmaps , hyperloglogs 和地理空间 (geospatial ）索引半径查询。Redis 内置了复制 ( replication )，LUA 脚本 ( Lua<br>scripting)，LRU 驱动事件（LRU eviction )，事务 (transactions）和不同级别的磁盘持久化 ( persistence)，并通过 Redis 哨兵 (Sentinel) 和自动分区（Cluster ) 提供高可用性 ( high availability )。</p><p><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi9jb21tYW5kcy5odG1s">Redis 命令中心</span></p><h3 id="redis-key"><a class="anchor" href="#redis-key">#</a> Redis-Key</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name qwq <span class="token comment"># 设置一个键值对</span></pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> EXISTS name <span class="token comment"># 查询是否存在某个键</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> EXISTS qwq</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> move name <span class="token number">1</span> <span class="token comment"># 将指定键值对移动到指定数据库</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> expire name <span class="token number">10</span> <span class="token comment"># 设置指定键值对的过期时间 此处为 10 秒</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ttl name <span class="token comment"># 查看指定键值对剩余有效时间</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ttl name</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ttl name</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ttl name</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ttl name <span class="token comment"># 有效时间为 - 2 时表示已失效</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -2</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">type</span> age <span class="token comment"># 查看 key 所储存的值的类型</span></pre></td></tr><tr><td data-num="22"></td><td><pre>string</pre></td></tr></table></figure><h3 id="string"><a class="anchor" href="#string">#</a> String</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name qwq</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> exist name</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> append name qqqq <span class="token comment"># 在字符串后追加字符串</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">7</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get name</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token string">"qwqqqqq"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> strlen name <span class="token comment"># 获取字符串长度</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">7</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># ==============================</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> views <span class="token number">0</span></pre></td></tr><tr><td data-num="13"></td><td><pre>OK</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> incr views <span class="token comment"># 加一操作</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get views</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token string">"1"</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> decr views <span class="token comment"># 减一操作</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get views</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token string">"0"</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> incrby views <span class="token number">2</span> <span class="token comment"># 设置增长步长</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get views</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token string">"2"</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> decrby views <span class="token number">3</span> <span class="token comment"># 设置减少步长</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -1</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get views</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token string">"-1"</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> hello <span class="token string">"hello world"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>OK</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get hello</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token string">"hello world"</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> GETRANGE hello <span class="token number">6</span> <span class="token number">10</span> <span class="token comment"># 截取子串</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token string">"world"</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> GETRANGE hello <span class="token number">0</span> -1 <span class="token comment"># 获取整个字符串，相当于 get key</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token string">"hello world"</span>						<span class="token comment"># -1 表示最后一个字符的下标</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SETRANGE hello <span class="token number">6</span> qwqqq <span class="token comment"># 替换指定位置开始的字符串</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">11</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get hello</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token string">"hello qwqqq"</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># setex (set with expire) 设置过期时间</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># setnx (set if not exist) 如果不存在就设置，在分布式锁中常常用到</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SETEX name <span class="token number">10</span> qwqq</pre></td></tr><tr><td data-num="47"></td><td><pre>OK</pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SETNX name qwq <span class="token comment"># 如果存在则设置失败，返回 0</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ttl name</pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -2</pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SETNX name qwq <span class="token comment"># 如果不存在则设置成功，返回 1</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># mset 同时设置多个值</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment"># mget 同时取得多个值</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> mset k1 v1 k2 v2 k3 v3</pre></td></tr><tr><td data-num="58"></td><td><pre>OK</pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k1"</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"k3"</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> mget k1 k2 k3</pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"v1"</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"v2"</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"v3"</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> msetnx k1 v1 k4 v4 <span class="token comment"># 同时设置多个键值对，该命令为原子性操作，要么全成功，要么全失败</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k1"</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"k3"</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> msetnx k4 v4 k5 v5</pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k5"</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"k4"</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"k1"</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"k3"</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># ==============================</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># getset 先 get 再 set 如果不存在值则返回 nil 如果存在则获取原来的值并设置新的值</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getset name qwq</pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">(</span>nil<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name"</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get name</pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token string">"qwq"</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> getset name bbmb</pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token string">"qwq"</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get name</pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token string">"bbmb"</span></pre></td></tr></table></figure><p>String 类型的使用场景:</p><ul><li>计数器</li><li>统计多单位的数量</li><li>粉丝数</li><li>对象缓存存储</li></ul><h3 id="list"><a class="anchor" href="#list">#</a> List</h3><p>基本的数据类型，列表</p><p>redis 中可以使用 list 实现栈，队列...</p><p>所有 list 命令都是以<strong> l</strong> 开头的</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># lpush</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># rpush</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lpush list <span class="token number">1</span> <span class="token comment"># 将值插入列表头部 left push</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lpush list <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token comment"># 可插入多个值</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpush list <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token comment"># 将值插入列表尾部 right push</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">7</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># lpop 移除头部的值 可指定数量</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># rpop 移除尾部的值 可指定数量</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lpop list <span class="token comment"># 移除头部第一个值</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token string">"4"</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpop list <span class="token number">2</span> <span class="token comment"># 移除尾部的两个值</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># lindex 获取指定下标的值 注：下标从 0 开始！！！</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> LINDEX list <span class="token number">3</span> <span class="token comment">#对应上面的 4) "2"</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token string">"2"</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment"># llen key 返回 list 的长度</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> llen list</pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#  lrem key count element 移除 list 中指定数量的指定元素 返回值为成功移除的元素数量</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpush list <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">2</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">5</span> <span class="token number">6</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">13</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="59"></td><td><pre> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="65"></td><td><pre> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token number">11</span><span class="token punctuation">)</span> <span class="token string">"5"</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token number">12</span><span class="token punctuation">)</span> <span class="token string">"5"</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token number">13</span><span class="token punctuation">)</span> <span class="token string">"6"</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrem list <span class="token number">3</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="73"></td><td><pre> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="75"></td><td><pre> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="76"></td><td><pre> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="78"></td><td><pre> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="80"></td><td><pre> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"5"</span></pre></td></tr><tr><td data-num="81"></td><td><pre> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">"5"</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">"6"</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment"># ltrim key start stop 截断列表，会修改原列表的数据</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> ltrim list <span class="token number">1</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="86"></td><td><pre>OK</pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment"># rpoplpush source destination 移除列表最后一个元素，将其添加到一个新的列表的前面</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpush list1 <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpush list2 <span class="token number">4</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list1 <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list2 <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"5"</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> RPOPLPUSH list1 list2</pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token string">"3"</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list1 <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"1"</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list2 <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"3"</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"4"</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"5"</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># lset key index element 将列表中指定下标的值替换成另外一个值 列表不存在与下标不存在的时候均会报错</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> exists list</pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token punctuation">(</span>empty array<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lset list <span class="token number">0</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR no such key</pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpush list qwq</pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lset list <span class="token number">0</span> bmb</pre></td></tr><tr><td data-num="126"></td><td><pre>OK</pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"bmb"</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lset list <span class="token number">1</span> bbmb</pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR index out of range</pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token comment"># =========================================================</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token comment"># linsert key BEFORE|AFTER pivot element   pivot 指想要插入位置的值</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> rpush list <span class="token string">"hello"</span> <span class="token string">"world"</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"hello"</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"world"</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> linsert list after hello my</pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> lrange list <span class="token number">0</span> -1</pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"hello"</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"my"</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"world"</span></pre></td></tr></table></figure><blockquote><p>小结</p></blockquote><ul><li>list 实际上是一个链表</li><li>如果 key 不存在，创建新链表</li><li>如果 key 存在，新增内容</li><li>如果移除了所有值，空链表，也代表不存在！</li><li>在两边插入或者改动值，效率最高！中间元素，相对来说效率会低一点～</li></ul><h3 id="set"><a class="anchor" href="#set">#</a> Set</h3><p>set 无序不重复集合</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sadd key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token comment"># 向 set 中添加 member</span></pre></td></tr><tr><td data-num="2"></td><td><pre>smembers key <span class="token comment"># 输出 set 中的所有 member</span></pre></td></tr><tr><td data-num="3"></td><td><pre>sismember key member <span class="token comment"># 判断 set 中是否存在该 member</span></pre></td></tr><tr><td data-num="4"></td><td><pre>scard key <span class="token comment"># 获取 set 集合元素个数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>srem key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token comment"># 移除 set 中的指定 member</span></pre></td></tr><tr><td data-num="6"></td><td><pre>srandmember key <span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token comment"># 随机取出 set 中的 member 可指定数量</span></pre></td></tr><tr><td data-num="7"></td><td><pre>spop key <span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token comment"># 随机删除 set 中的 member 可指定数量</span></pre></td></tr><tr><td data-num="8"></td><td><pre>smove <span class="token builtin class-name">source</span> destination member <span class="token comment"># 移动指定的元素</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">sdiff</span> key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token comment"># 返回第一个 set 与其他 set 之间的差异，也就是第一个 set 中独有的元素 差集</span></pre></td></tr><tr><td data-num="10"></td><td><pre>sinter key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token comment"># 返回多个 set 的交集</span></pre></td></tr><tr><td data-num="11"></td><td><pre>sunion key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token comment"># 返回多个 set 的并集</span></pre></td></tr></table></figure><h3 id="hash"><a class="anchor" href="#hash">#</a> Hash</h3><p>Map 集合 key - map map 中存储键值对</p><p>有点类似 json 对象的存储</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>HDEL key field <span class="token punctuation">[</span>field <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre>summary: Delete one or <span class="token function">more</span> <span class="token builtin class-name">hash</span> fields</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>HEXISTS key field</pre></td></tr><tr><td data-num="5"></td><td><pre>summary: Determine <span class="token keyword">if</span> a <span class="token builtin class-name">hash</span> field exists</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>HGET key field</pre></td></tr><tr><td data-num="8"></td><td><pre>summary: Get the value of a <span class="token builtin class-name">hash</span> field</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>HGETALL key</pre></td></tr><tr><td data-num="11"></td><td><pre>summary: Get all the fields and values <span class="token keyword">in</span> a <span class="token builtin class-name">hash</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>HINCRBY key field increment</pre></td></tr><tr><td data-num="14"></td><td><pre>summary: Increment the integer value of a <span class="token builtin class-name">hash</span> field by the given number</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>HINCRBYFLOAT key field increment</pre></td></tr><tr><td data-num="17"></td><td><pre>summary: Increment the float value of a <span class="token builtin class-name">hash</span> field by the given amount</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>HKEYS key</pre></td></tr><tr><td data-num="20"></td><td><pre>summary: Get all the fields <span class="token keyword">in</span> a <span class="token builtin class-name">hash</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>HLEN key</pre></td></tr><tr><td data-num="23"></td><td><pre>summary: Get the number of fields <span class="token keyword">in</span> a <span class="token builtin class-name">hash</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>HMGET key field <span class="token punctuation">[</span>field <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre>summary: Get the values of all the given <span class="token builtin class-name">hash</span> fields</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 过时 可直接使用 hset 设置多个 key-value</span></pre></td></tr><tr><td data-num="29"></td><td><pre>HMSET key field value <span class="token punctuation">[</span>field value <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>summary: Set multiple <span class="token builtin class-name">hash</span> fields to multiple values</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>HRANDFIELD key <span class="token punctuation">[</span>count <span class="token punctuation">[</span>WITHVALUES<span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="33"></td><td><pre>summary: Get one or multiple random fields from a <span class="token builtin class-name">hash</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>HSCAN key cursor <span class="token punctuation">[</span>MATCH pattern<span class="token punctuation">]</span> <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre>summary: Incrementally iterate <span class="token builtin class-name">hash</span> fields and associated values</pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>HSET key field value <span class="token punctuation">[</span>field value <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="39"></td><td><pre>summary: Set the string value of a <span class="token builtin class-name">hash</span> field</pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>HSETNX key field value</pre></td></tr><tr><td data-num="42"></td><td><pre>summary: Set the value of a <span class="token builtin class-name">hash</span> field, only <span class="token keyword">if</span> the field does not exist</pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>HSTRLEN key field</pre></td></tr><tr><td data-num="45"></td><td><pre>summary: Get the length of the value of a <span class="token builtin class-name">hash</span> field</pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>HVALS key</pre></td></tr><tr><td data-num="48"></td><td><pre>summary: Get all the values <span class="token keyword">in</span> a <span class="token builtin class-name">hash</span></pre></td></tr></table></figure><p>hash 更适合对象的存储，string 更适合字符串存储</p><h3 id="zset"><a class="anchor" href="#zset">#</a> Zset</h3><p>官方命名为 sorted_set, 意为有序集合</p><p>在添加 member 时需要写入权重，根据权重排序</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>BZPOPMAX key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token function">timeout</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  summary: Remove and <span class="token builtin class-name">return</span> the member with the highest score from one or <span class="token function">more</span> sorted sets, or block <span class="token keyword">until</span> one is available</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>  BZPOPMIN key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token function">timeout</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  summary: Remove and <span class="token builtin class-name">return</span> the member with the lowest score from one or <span class="token function">more</span> sorted sets, or block <span class="token keyword">until</span> one is available</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  ZADD key <span class="token punctuation">[</span>NX<span class="token operator">|</span>XX<span class="token punctuation">]</span> <span class="token punctuation">[</span>GT<span class="token operator">|</span>LT<span class="token punctuation">]</span> <span class="token punctuation">[</span>CH<span class="token punctuation">]</span> <span class="token punctuation">[</span>INCR<span class="token punctuation">]</span> score member <span class="token punctuation">[</span>score member <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  summary: Add one or <span class="token function">more</span> members to a sorted set, or update its score <span class="token keyword">if</span> it already exists</pre></td></tr><tr><td data-num="9"></td><td><pre> 	XX: 仅仅更新存在的成员，不添加新成员。</pre></td></tr><tr><td data-num="10"></td><td><pre>	NX: 不更新存在的成员。只添加新成员。</pre></td></tr><tr><td data-num="11"></td><td><pre>	CH: 修改返回值为发生变化的成员总数，原始是返回新添加成员的总数 <span class="token punctuation">(</span>CH 是 changed 的意思<span class="token punctuation">)</span>。更改的元素是新添加的成员，已经存在的成员更新分数。 所以在命令中指定的成员有相同的分数将不被计算在内。注：在通常情况下，ZADD返回值只计算新添加成员的数量。</pre></td></tr><tr><td data-num="12"></td><td><pre>	INCR: 当ZADD指定这个选项时，成员的操作就等同ZINCRBY命令，对成员的分数进行递增操作。</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  ZCARD key</pre></td></tr><tr><td data-num="15"></td><td><pre>  summary: Get the number of members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  ZCOUNT key min max</pre></td></tr><tr><td data-num="18"></td><td><pre>  summary: Count the members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span> with scores within the given values</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  ZDIFF numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  summary: Subtract multiple sorted sets</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  ZDIFFSTORE destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  summary: Subtract multiple sorted sets and store the resulting sorted <span class="token builtin class-name">set</span> <span class="token keyword">in</span> a new key</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  ZINCRBY key increment member</pre></td></tr><tr><td data-num="27"></td><td><pre>  summary: Increment the score of a member <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  ZINTER numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>WEIGHTS weight<span class="token punctuation">]</span> <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  summary: Intersect multiple sorted sets</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  ZINTERSTORE destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>WEIGHTS weight<span class="token punctuation">]</span> <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  summary: Intersect multiple sorted sets and store the resulting sorted <span class="token builtin class-name">set</span> <span class="token keyword">in</span> a new key</pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  ZLEXCOUNT key min max</pre></td></tr><tr><td data-num="36"></td><td><pre>  summary: Count the number of members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span> between a given lexicographical range</pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  ZMSCORE key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  summary: Get the score associated with the given members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  ZPOPMAX key <span class="token punctuation">[</span>count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  summary: Remove and <span class="token builtin class-name">return</span> members with the highest scores <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  ZPOPMIN key <span class="token punctuation">[</span>count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  summary: Remove and <span class="token builtin class-name">return</span> members with the lowest scores <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  ZRANDMEMBER key <span class="token punctuation">[</span>count <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  summary: Get one or multiple random elements from a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>  ZRANGE key min max <span class="token punctuation">[</span>BYSCORE<span class="token operator">|</span>BYLEX<span class="token punctuation">]</span> <span class="token punctuation">[</span>REV<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  summary: Return a range of members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  ZRANGEBYLEX key min max <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  summary: Return a range of members <span class="token keyword">in</span> a sorted set, by lexicographical range</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  ZRANGEBYSCORE key min max <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  summary: Return a range of members <span class="token keyword">in</span> a sorted set, by score</pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  ZRANGESTORE dst src min max <span class="token punctuation">[</span>BYSCORE<span class="token operator">|</span>BYLEX<span class="token punctuation">]</span> <span class="token punctuation">[</span>REV<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  summary: Store a range of members from sorted <span class="token builtin class-name">set</span> into another key</pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>  ZRANK key member</pre></td></tr><tr><td data-num="63"></td><td><pre>  summary: Determine the index of a member <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>  ZREM key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  summary: Remove one or <span class="token function">more</span> members from a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>  ZREMRANGEBYLEX key min max</pre></td></tr><tr><td data-num="69"></td><td><pre>  summary: Remove all members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span> between the given lexicographical range</pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>  ZREMRANGEBYRANK key start stop</pre></td></tr><tr><td data-num="72"></td><td><pre>  summary: Remove all members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span> within the given indexes</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>  ZREMRANGEBYSCORE key min max</pre></td></tr><tr><td data-num="75"></td><td><pre>  summary: Remove all members <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span> within the given scores</pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>  ZREVRANGE key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  summary: Return a range of members <span class="token keyword">in</span> a sorted set, by index, with scores ordered from high to low</pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>  ZREVRANGEBYLEX key max min <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  summary: Return a range of members <span class="token keyword">in</span> a sorted set, by lexicographical range, ordered from higher to lower strings.</pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>  ZREVRANGEBYSCORE key max min <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  summary: Return a range of members <span class="token keyword">in</span> a sorted set, by score, with scores ordered from high to low</pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>  ZREVRANK key member</pre></td></tr><tr><td data-num="87"></td><td><pre>  summary: Determine the index of a member <span class="token keyword">in</span> a sorted set, with scores ordered from high to low</pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>  ZSCAN key cursor <span class="token punctuation">[</span>MATCH pattern<span class="token punctuation">]</span> <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  summary: Incrementally iterate sorted sets elements and associated scores</pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>  ZSCORE key member</pre></td></tr><tr><td data-num="93"></td><td><pre>  summary: Get the score associated with the given member <span class="token keyword">in</span> a sorted <span class="token builtin class-name">set</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>  ZUNION numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>WEIGHTS weight<span class="token punctuation">]</span> <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  summary: Add multiple sorted sets</pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>  ZUNIONSTORE destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>WEIGHTS weight<span class="token punctuation">]</span> <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  summary: Add multiple sorted sets and store the resulting sorted <span class="token builtin class-name">set</span> <span class="token keyword">in</span> a new key</pre></td></tr></table></figure><p>案例思路:</p><ul><li>set 排序存储班级成绩表，工资表排序！</li><li>普通消息，1，重要消息 2，带权重进行判断！</li><li>排行榜应用实现，取 Top N 测试！</li></ul><h2 id="三种特殊数据类型"><a class="anchor" href="#三种特殊数据类型">#</a> 三种特殊数据类型</h2><h3 id="geospatial"><a class="anchor" href="#geospatial">#</a> geospatial</h3><h3 id="hyperloglog"><a class="anchor" href="#hyperloglog">#</a> hyperloglog</h3><h3 id="bitmaps"><a class="anchor" href="#bitmaps">#</a> bitmaps</h3><h2 id="redis事务"><a class="anchor" href="#redis事务">#</a> Redis 事务</h2><p>Redis 事务的本质：一组命令的集合！一个事务中的所有命令都会被序列化，在事务执行过程的中，会按照顺序执行！</p><p><strong><mark>Redis 事务不保证原子性，它的单条命令保证原子性，但事务不保证原子性！</mark></strong></p><p>一次性、顺序性、排他性！执行一些列的命令！</p><p><mark>Redis 事务没有没有隔离级别的概念！</mark></p><p>所有的命令在入队时，并没有直接被执行，而是在队列中等待执行。只有发起执行命令的时候才会执行！ Exec</p><p>redis 的事务∶</p><ul><li>开启事务 (multi)</li><li>命令入队 (...)</li><li>执行事务 (exec)/ 放弃事务 (discard)</li></ul><blockquote><p>错误类型</p></blockquote><ul><li>命令语法有误 (编译型错误)<ul><li>如命令敲错了</li><li>事务中所有命令都不会被执行</li></ul></li><li>命令逻辑错误 (运行时错误)<ul><li>如多次设置同一个 key</li><li>执行命令时其他没错的命令可以正常执行</li><li>错误命令会报错</li></ul></li></ul><blockquote><p>Redis 的事务更加像是一种命令的批处理，批量执行命令。</p></blockquote><h3 id="监视"><a class="anchor" href="#监视">#</a> 监视</h3><ul><li>悲观锁:<ul><li>很悲观，认为什么时候都会出问题，无论做什么都会加锁！操作数据时锁定数据，操作完毕后解锁数据。锁定期间其他线程无法操作该数据。</li></ul></li><li>乐观锁︰<ul><li>很乐观，认为什么时候都不会出问题，所以不会上锁！取数据时直接取出数据，更新数据的时候去判断一下，在此期间是否有人修改过这个数据，若没人修改则提交修改，若有人修改则回滚返回错误信息。</li><li>MySQL 添加字段 version 通过对比 version 版本实现乐观锁</li></ul></li></ul><p>redis 监视：</p><p>事务正常执行成功：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> money <span class="token number">100</span></pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> out <span class="token number">0</span></pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token function">watch</span> money <span class="token comment"># 监视 money 对象</span></pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> multi <span class="token comment"># 事务正常结束，在此期间没有其他线程改变 money 的值，就正常执行成功</span></pre></td></tr><tr><td data-num="8"></td><td><pre>OK</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> decrby money <span class="token number">20</span></pre></td></tr><tr><td data-num="10"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> incrby out <span class="token number">20</span></pre></td></tr><tr><td data-num="12"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> <span class="token builtin class-name">exec</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 事务结束后监视会自动取消</span></pre></td></tr></table></figure><p>模拟插队修改：</p><p>终端 1：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token function">watch</span> money</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> MULTI</pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> DECRBY money <span class="token number">10</span></pre></td></tr><tr><td data-num="6"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> INCRBY out <span class="token number">10</span></pre></td></tr><tr><td data-num="8"></td><td><pre>QUEUED </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> 					<span class="token comment"># 先不执行事务，使用终端 2 模拟插队</span></pre></td></tr></table></figure><p>终端 2：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get money</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">"80"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> INCRBY money <span class="token number">1000</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1080</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span>							<span class="token comment"># 终端 2 插队修改 money 成功</span></pre></td></tr></table></figure><p>此时终端 1 执行事务：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> <span class="token builtin class-name">exec</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>nil<span class="token punctuation">)</span>									<span class="token comment"># 返回 nil，表示整个事务执行失败，事务中的所有命令均不会执行</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># =========================== 执行失败后的处理方法 ==============================</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> UNWATCH					<span class="token comment"># 取消监视</span></pre></td></tr><tr><td data-num="5"></td><td><pre>OK</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> WATCH money				<span class="token comment"># 重新监视最新值</span></pre></td></tr><tr><td data-num="7"></td><td><pre>OK</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> MULTI</pre></td></tr><tr><td data-num="9"></td><td><pre>OK</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> DECRBY monsy <span class="token number">100</span></pre></td></tr><tr><td data-num="11"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> INCRBY out <span class="token number">100</span></pre></td></tr><tr><td data-num="13"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">></span> <span class="token builtin class-name">exec</span>				<span class="token comment"># 执行事务，若监视的值未改变则执行成功</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">980</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">110</span></pre></td></tr></table></figure><h2 id="jedis"><a class="anchor" href="#jedis">#</a> Jedis</h2><h3 id="开始"><a class="anchor" href="#开始">#</a> 开始</h3><p>导包：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.62<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-nop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.7.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>连接 Redis：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token comment">//new 一个 jedis 对象</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">//jedis 的命令与 redis 中指令一致</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>输出：</pre></td></tr><tr><td data-num="8"></td><td><pre>PONG</pre></td></tr></table></figure><h3 id="事务"><a class="anchor" href="#事务">#</a> 事务</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TXTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">JSONObject</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        object<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"qwq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        object<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">,</span><span class="token string">"菜鸡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">flushDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 开启事务</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            transaction<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            transaction<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user2"</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            transaction<span class="token punctuation">.</span><span class="token function">discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span> <span class="token string">"user2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="springboot整合"><a class="anchor" href="#springboot整合">#</a> springboot 整合</h2><p>SpringBoot 操作数据：spring-data jpa jdbc mongodb redis！</p><p>SpringData 也是和 SpringBoot 齐名的项目！</p><p>说明︰在 SpringBoot2.x 之后，原来使用的 jedis 被替换为了 lettuce</p><p>jedis : 采用的直连，多个线程操作的话，是不安全的，如果想要避免不安全的，使用 jedis pool 连接池！更像 BIO 模式</p><p>lettuce : 采用 netty, 实例可以再多个线程中进行共享，不存在线程不安全的情况！可以减少线程数据了，更像 Nio 模式</p><p>源码分析：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"redisTemplate"</span><span class="token punctuation">)</span>  <span class="token comment">// 若没有 redisTemplate 才使用默认类，我们可以自己手动实现 redisTemplate 来替换默认</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 默认的 RedisTemplate 没有过多的设置 ，redis 保存对象都是需要序列化的</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   	<span class="token comment">// 两个泛型都是 Object ，使用需要强制类型转换</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> template<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@ConditionalOnMissingBean</span> <span class="token comment">// 由于 string 是 redis 中最常使用的类型，所以说单独提出来了一个 bean!</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> <span class="token function">stringRedisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">StringRedisTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> template<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>整合：</p><ol><li><p>导入依赖</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure></li><li><p>配置链接</p><figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">redis</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr></table></figure></li><li><p>编写测试类</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DataApplicationTests</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 操作 String opsForValue ()</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 操作 List opsForList ()</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 操作 Set opsForSet ()</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 操作 Hash opsForHash ()</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 常用方法可以直接通过 redisTemplate 进行操作，如事务等...</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"qwq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ol><p>redisConfig 默认使用 JDK 序列化（中文会转义成编码），我们可能使用 json 来序列化（序列化：把对象转化为可传输的字节序列过程称为序列化）</p><h3 id="自定义序列化"><a class="anchor" href="#自定义序列化">#</a> 自定义序列化</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 在企业中，一般所有 pojo 类都会序列化</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>RedisConfig.java:</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 自定义 RedisTemplate</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">//Json 序列化配置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">Jackson2JsonRedisSerializer</span> jsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        objectMapper<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        objectMapper<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        jsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// String 的序列化</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">StringRedisSerializer</span> stringRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">//key 采用 String 的序列化方式</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// Hash 的 key 采用 String 的序列化方式</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        template<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">//value 的序列化采用 Jackson</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// Hash 的 value 序列化方式采用 Jackson</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        template<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> template<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">redisSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"qwq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>输出：</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span>qwq<span class="token punctuation">)</span>    <span class="token comment">// 这里实际上自动将对象序列化为 json 字符串后取出时反序列化为了 User 对象</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get user</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">"[<span class="token entity" title="\&quot;">\"</span>com.wang.data.pojo.User<span class="token entity" title="\&quot;">\"</span>,&#123;<span class="token entity" title="\&quot;">\"</span>id<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>1<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>name<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>qwq<span class="token entity" title="\&quot;">\"</span>&#125;]"</span></pre></td></tr></table></figure><h3 id="redis工具类"><a class="anchor" href="#redis工具类">#</a> Redis 工具类</h3><p>spring 将 redis 封装成模板，将常用命令分类，但操作起来代码非常繁琐，于是我们一般使用工具类而不是直接使用 redisTemplate 类进行操作。</p><p>RedisUtil 将 redisTemplate 封装成了类似于<strong> Jedis</strong> 的操作。</p><p>RedisUtil.java</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RedisUtils</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// =============================common============================</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 指定缓存失效时间</pre></td></tr><tr><td data-num="23"></td><td><pre>     *</pre></td></tr><tr><td data-num="24"></td><td><pre>     * @param key  键</pre></td></tr><tr><td data-num="25"></td><td><pre>     * @param time 时间 (秒)</pre></td></tr><tr><td data-num="26"></td><td><pre>     */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="40"></td><td><pre>     * 根据 key 获取过期时间</pre></td></tr><tr><td data-num="41"></td><td><pre>     *</pre></td></tr><tr><td data-num="42"></td><td><pre>     * @param key 键 不能为 null</pre></td></tr><tr><td data-num="43"></td><td><pre>     * @return 时间 (秒) 返回 0 代表为永久有效</pre></td></tr><tr><td data-num="44"></td><td><pre>     */</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="51"></td><td><pre>     * 判断 key 是否存在</pre></td></tr><tr><td data-num="52"></td><td><pre>     *</pre></td></tr><tr><td data-num="53"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="54"></td><td><pre>     * @return true 存在 false 不存在</pre></td></tr><tr><td data-num="55"></td><td><pre>     */</pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="67"></td><td><pre>     * 删除缓存</pre></td></tr><tr><td data-num="68"></td><td><pre>     *</pre></td></tr><tr><td data-num="69"></td><td><pre>     * @param key 可以传一个值 或多个</pre></td></tr><tr><td data-num="70"></td><td><pre>     */</pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">arrayToList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token comment">// ============================String=============================</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="86"></td><td><pre>     * 普通缓存获取</pre></td></tr><tr><td data-num="87"></td><td><pre>     *</pre></td></tr><tr><td data-num="88"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="89"></td><td><pre>     * @return 值</pre></td></tr><tr><td data-num="90"></td><td><pre>     */</pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">return</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="96"></td><td><pre>     * 普通缓存放入</pre></td></tr><tr><td data-num="97"></td><td><pre>     *</pre></td></tr><tr><td data-num="98"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="99"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="100"></td><td><pre>     * @return true 成功 false 失败</pre></td></tr><tr><td data-num="101"></td><td><pre>     */</pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="115"></td><td><pre>     * 普通缓存放入并设置时间</pre></td></tr><tr><td data-num="116"></td><td><pre>     *</pre></td></tr><tr><td data-num="117"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="118"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="119"></td><td><pre>     * @param time  时间 (秒) time 要大于 0 如果 time 小于等于 0 将设置无限期</pre></td></tr><tr><td data-num="120"></td><td><pre>     * @return true 成功 false 失败</pre></td></tr><tr><td data-num="121"></td><td><pre>     */</pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="139"></td><td><pre>     * 递增</pre></td></tr><tr><td data-num="140"></td><td><pre>     *</pre></td></tr><tr><td data-num="141"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="142"></td><td><pre>     * @param delta 要增加几 (大于 0)</pre></td></tr><tr><td data-num="143"></td><td><pre>     */</pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">incr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> delta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"递增因子必须大于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="150"></td><td><pre></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="153"></td><td><pre>     * 递减</pre></td></tr><tr><td data-num="154"></td><td><pre>     *</pre></td></tr><tr><td data-num="155"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="156"></td><td><pre>     * @param delta 要减少几 (小于 0)</pre></td></tr><tr><td data-num="157"></td><td><pre>     */</pre></td></tr><tr><td data-num="158"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">decr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> delta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"递减因子必须大于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">-</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="164"></td><td><pre></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre>    <span class="token comment">// ================================Map=================================</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="169"></td><td><pre>     * HashGet</pre></td></tr><tr><td data-num="170"></td><td><pre>     *</pre></td></tr><tr><td data-num="171"></td><td><pre>     * @param key  键 不能为 null</pre></td></tr><tr><td data-num="172"></td><td><pre>     * @param item 项 不能为 null</pre></td></tr><tr><td data-num="173"></td><td><pre>     */</pre></td></tr><tr><td data-num="174"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">hget</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="179"></td><td><pre>     * 获取 hashKey 对应的所有键值</pre></td></tr><tr><td data-num="180"></td><td><pre>     *</pre></td></tr><tr><td data-num="181"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="182"></td><td><pre>     * @return 对应的多个键值</pre></td></tr><tr><td data-num="183"></td><td><pre>     */</pre></td></tr><tr><td data-num="184"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">hmget</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="187"></td><td><pre></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="189"></td><td><pre>     * HashSet</pre></td></tr><tr><td data-num="190"></td><td><pre>     *</pre></td></tr><tr><td data-num="191"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="192"></td><td><pre>     * @param map 对应多个键值</pre></td></tr><tr><td data-num="193"></td><td><pre>     */</pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hmset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="203"></td><td><pre></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="206"></td><td><pre>     * HashSet 并设置时间</pre></td></tr><tr><td data-num="207"></td><td><pre>     *</pre></td></tr><tr><td data-num="208"></td><td><pre>     * @param key  键</pre></td></tr><tr><td data-num="209"></td><td><pre>     * @param map  对应多个键值</pre></td></tr><tr><td data-num="210"></td><td><pre>     * @param time 时间 (秒)</pre></td></tr><tr><td data-num="211"></td><td><pre>     * @return true 成功 false 失败</pre></td></tr><tr><td data-num="212"></td><td><pre>     */</pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hmset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="217"></td><td><pre>                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="218"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="225"></td><td><pre></pre></td></tr><tr><td data-num="226"></td><td><pre></pre></td></tr><tr><td data-num="227"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="228"></td><td><pre>     * 向一张 hash 表中放入数据，如果不存在将创建</pre></td></tr><tr><td data-num="229"></td><td><pre>     *</pre></td></tr><tr><td data-num="230"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="231"></td><td><pre>     * @param item  项</pre></td></tr><tr><td data-num="232"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="233"></td><td><pre>     * @return true 成功 false 失败</pre></td></tr><tr><td data-num="234"></td><td><pre>     */</pre></td></tr><tr><td data-num="235"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="236"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="237"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="239"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="240"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="241"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="243"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="244"></td><td><pre></pre></td></tr><tr><td data-num="245"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="246"></td><td><pre>     * 向一张 hash 表中放入数据，如果不存在将创建</pre></td></tr><tr><td data-num="247"></td><td><pre>     *</pre></td></tr><tr><td data-num="248"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="249"></td><td><pre>     * @param item  项</pre></td></tr><tr><td data-num="250"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="251"></td><td><pre>     * @param time  时间 (秒) 注意：如果已存在的 hash 表有时间，这里将会替换原有的时间</pre></td></tr><tr><td data-num="252"></td><td><pre>     * @return true 成功 false 失败</pre></td></tr><tr><td data-num="253"></td><td><pre>     */</pre></td></tr><tr><td data-num="254"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="260"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="261"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="262"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="263"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="265"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="266"></td><td><pre></pre></td></tr><tr><td data-num="267"></td><td><pre></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="269"></td><td><pre>     * 删除 hash 表中的值</pre></td></tr><tr><td data-num="270"></td><td><pre>     *</pre></td></tr><tr><td data-num="271"></td><td><pre>     * @param key  键 不能为 null</pre></td></tr><tr><td data-num="272"></td><td><pre>     * @param item 项 可以使多个 不能为 null</pre></td></tr><tr><td data-num="273"></td><td><pre>     */</pre></td></tr><tr><td data-num="274"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hdel</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> item<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="277"></td><td><pre></pre></td></tr><tr><td data-num="278"></td><td><pre></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="280"></td><td><pre>     * 判断 hash 表中是否有该项的值</pre></td></tr><tr><td data-num="281"></td><td><pre>     *</pre></td></tr><tr><td data-num="282"></td><td><pre>     * @param key  键 不能为 null</pre></td></tr><tr><td data-num="283"></td><td><pre>     * @param item 项 不能为 null</pre></td></tr><tr><td data-num="284"></td><td><pre>     * @return true 存在 false 不存在</pre></td></tr><tr><td data-num="285"></td><td><pre>     */</pre></td></tr><tr><td data-num="286"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hHasKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="288"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="289"></td><td><pre></pre></td></tr><tr><td data-num="290"></td><td><pre></pre></td></tr><tr><td data-num="291"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="292"></td><td><pre>     * hash 递增 如果不存在，就会创建一个 并把新增后的值返回</pre></td></tr><tr><td data-num="293"></td><td><pre>     *</pre></td></tr><tr><td data-num="294"></td><td><pre>     * @param key  键</pre></td></tr><tr><td data-num="295"></td><td><pre>     * @param item 项</pre></td></tr><tr><td data-num="296"></td><td><pre>     * @param by   要增加几 (大于 0)</pre></td></tr><tr><td data-num="297"></td><td><pre>     */</pre></td></tr><tr><td data-num="298"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">hincr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token keyword">double</span> by<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="299"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> by<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="300"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="301"></td><td><pre></pre></td></tr><tr><td data-num="302"></td><td><pre></pre></td></tr><tr><td data-num="303"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="304"></td><td><pre>     * hash 递减</pre></td></tr><tr><td data-num="305"></td><td><pre>     *</pre></td></tr><tr><td data-num="306"></td><td><pre>     * @param key  键</pre></td></tr><tr><td data-num="307"></td><td><pre>     * @param item 项</pre></td></tr><tr><td data-num="308"></td><td><pre>     * @param by   要减少记 (小于 0)</pre></td></tr><tr><td data-num="309"></td><td><pre>     */</pre></td></tr><tr><td data-num="310"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">hdecr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token keyword">double</span> by<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="311"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token operator">-</span>by<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="312"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="313"></td><td><pre></pre></td></tr><tr><td data-num="314"></td><td><pre></pre></td></tr><tr><td data-num="315"></td><td><pre>    <span class="token comment">// ============================set=============================</span></pre></td></tr><tr><td data-num="316"></td><td><pre></pre></td></tr><tr><td data-num="317"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="318"></td><td><pre>     * 根据 key 获取 Set 中的所有值</pre></td></tr><tr><td data-num="319"></td><td><pre>     *</pre></td></tr><tr><td data-num="320"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="321"></td><td><pre>     */</pre></td></tr><tr><td data-num="322"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">sGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="324"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="325"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="326"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="327"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="329"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="330"></td><td><pre></pre></td></tr><tr><td data-num="331"></td><td><pre></pre></td></tr><tr><td data-num="332"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="333"></td><td><pre>     * 根据 value 从一个 set 中查询，是否存在</pre></td></tr><tr><td data-num="334"></td><td><pre>     *</pre></td></tr><tr><td data-num="335"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="336"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="337"></td><td><pre>     * @return true 存在 false 不存在</pre></td></tr><tr><td data-num="338"></td><td><pre>     */</pre></td></tr><tr><td data-num="339"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sHasKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="341"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="342"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="343"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="344"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="345"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="346"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="347"></td><td><pre></pre></td></tr><tr><td data-num="348"></td><td><pre></pre></td></tr><tr><td data-num="349"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="350"></td><td><pre>     * 将数据放入 set 缓存</pre></td></tr><tr><td data-num="351"></td><td><pre>     *</pre></td></tr><tr><td data-num="352"></td><td><pre>     * @param key    键</pre></td></tr><tr><td data-num="353"></td><td><pre>     * @param values 值 可以是多个</pre></td></tr><tr><td data-num="354"></td><td><pre>     * @return 成功个数</pre></td></tr><tr><td data-num="355"></td><td><pre>     */</pre></td></tr><tr><td data-num="356"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="357"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="358"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="359"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="361"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="363"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="364"></td><td><pre></pre></td></tr><tr><td data-num="365"></td><td><pre></pre></td></tr><tr><td data-num="366"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="367"></td><td><pre>     * 将 set 数据放入缓存</pre></td></tr><tr><td data-num="368"></td><td><pre>     *</pre></td></tr><tr><td data-num="369"></td><td><pre>     * @param key    键</pre></td></tr><tr><td data-num="370"></td><td><pre>     * @param time   时间 (秒)</pre></td></tr><tr><td data-num="371"></td><td><pre>     * @param values 值 可以是多个</pre></td></tr><tr><td data-num="372"></td><td><pre>     * @return 成功个数</pre></td></tr><tr><td data-num="373"></td><td><pre>     */</pre></td></tr><tr><td data-num="374"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sSetAndTime</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="375"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="376"></td><td><pre>            <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="377"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="378"></td><td><pre>                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="379"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="380"></td><td><pre>            <span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="381"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="382"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="383"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="384"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="385"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="386"></td><td><pre></pre></td></tr><tr><td data-num="387"></td><td><pre></pre></td></tr><tr><td data-num="388"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="389"></td><td><pre>     * 获取 set 缓存的长度</pre></td></tr><tr><td data-num="390"></td><td><pre>     *</pre></td></tr><tr><td data-num="391"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="392"></td><td><pre>     */</pre></td></tr><tr><td data-num="393"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sGetSetSize</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="394"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="395"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="396"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="397"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="398"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="399"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="400"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="401"></td><td><pre></pre></td></tr><tr><td data-num="402"></td><td><pre></pre></td></tr><tr><td data-num="403"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="404"></td><td><pre>     * 移除值为 value 的</pre></td></tr><tr><td data-num="405"></td><td><pre>     *</pre></td></tr><tr><td data-num="406"></td><td><pre>     * @param key    键</pre></td></tr><tr><td data-num="407"></td><td><pre>     * @param values 值 可以是多个</pre></td></tr><tr><td data-num="408"></td><td><pre>     * @return 移除的个数</pre></td></tr><tr><td data-num="409"></td><td><pre>     */</pre></td></tr><tr><td data-num="410"></td><td><pre></pre></td></tr><tr><td data-num="411"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">setRemove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="412"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="413"></td><td><pre>            <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="414"></td><td><pre>            <span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="415"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="416"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="417"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="418"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="419"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="420"></td><td><pre></pre></td></tr><tr><td data-num="421"></td><td><pre>    <span class="token comment">// ===============================list=================================</span></pre></td></tr><tr><td data-num="422"></td><td><pre></pre></td></tr><tr><td data-num="423"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="424"></td><td><pre>     * 获取 list 缓存的内容</pre></td></tr><tr><td data-num="425"></td><td><pre>     *</pre></td></tr><tr><td data-num="426"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="427"></td><td><pre>     * @param start 开始</pre></td></tr><tr><td data-num="428"></td><td><pre>     * @param end   结束 0 到 -1 代表所有值</pre></td></tr><tr><td data-num="429"></td><td><pre>     */</pre></td></tr><tr><td data-num="430"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">lGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="431"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="432"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="433"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="434"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="435"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="436"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="437"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="438"></td><td><pre></pre></td></tr><tr><td data-num="439"></td><td><pre></pre></td></tr><tr><td data-num="440"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="441"></td><td><pre>     * 获取 list 缓存的长度</pre></td></tr><tr><td data-num="442"></td><td><pre>     *</pre></td></tr><tr><td data-num="443"></td><td><pre>     * @param key 键</pre></td></tr><tr><td data-num="444"></td><td><pre>     */</pre></td></tr><tr><td data-num="445"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">lGetListSize</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="446"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="447"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="448"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="449"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="450"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="451"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="452"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="453"></td><td><pre></pre></td></tr><tr><td data-num="454"></td><td><pre></pre></td></tr><tr><td data-num="455"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="456"></td><td><pre>     * 通过索引 获取 list 中的值</pre></td></tr><tr><td data-num="457"></td><td><pre>     *</pre></td></tr><tr><td data-num="458"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="459"></td><td><pre>     * @param index 索引 index>=0 时， 0 表头，1 第二个元素，依次类推；index&lt;0 时，-1，表尾，-2 倒数第二个元素，依次类推</pre></td></tr><tr><td data-num="460"></td><td><pre>     */</pre></td></tr><tr><td data-num="461"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">lGetIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="462"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="463"></td><td><pre>            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="464"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="465"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="466"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="467"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="468"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="469"></td><td><pre></pre></td></tr><tr><td data-num="470"></td><td><pre></pre></td></tr><tr><td data-num="471"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="472"></td><td><pre>     * 将 list 放入缓存</pre></td></tr><tr><td data-num="473"></td><td><pre>     *</pre></td></tr><tr><td data-num="474"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="475"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="476"></td><td><pre>     */</pre></td></tr><tr><td data-num="477"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="478"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="479"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPush</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="480"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="481"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="482"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="483"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="484"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="485"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="486"></td><td><pre></pre></td></tr><tr><td data-num="487"></td><td><pre></pre></td></tr><tr><td data-num="488"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="489"></td><td><pre>     * 将 list 放入缓存</pre></td></tr><tr><td data-num="490"></td><td><pre>     *</pre></td></tr><tr><td data-num="491"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="492"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="493"></td><td><pre>     * @param time  时间 (秒)</pre></td></tr><tr><td data-num="494"></td><td><pre>     */</pre></td></tr><tr><td data-num="495"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span><span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="496"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="497"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPush</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="498"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="499"></td><td><pre>                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="500"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="501"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="502"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="503"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="504"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="505"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="506"></td><td><pre></pre></td></tr><tr><td data-num="507"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="508"></td><td><pre></pre></td></tr><tr><td data-num="509"></td><td><pre></pre></td></tr><tr><td data-num="510"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="511"></td><td><pre>     * 将 list 放入缓存</pre></td></tr><tr><td data-num="512"></td><td><pre>     *</pre></td></tr><tr><td data-num="513"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="514"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="515"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="516"></td><td><pre>     */</pre></td></tr><tr><td data-num="517"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="518"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="519"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="520"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="521"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="522"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="523"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="524"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="525"></td><td><pre></pre></td></tr><tr><td data-num="526"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="527"></td><td><pre></pre></td></tr><tr><td data-num="528"></td><td><pre></pre></td></tr><tr><td data-num="529"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="530"></td><td><pre>     * 将 list 放入缓存</pre></td></tr><tr><td data-num="531"></td><td><pre>     *</pre></td></tr><tr><td data-num="532"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="533"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="534"></td><td><pre>     * @param time  时间 (秒)</pre></td></tr><tr><td data-num="535"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="536"></td><td><pre>     */</pre></td></tr><tr><td data-num="537"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span><span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="538"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="539"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="540"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="541"></td><td><pre>                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="542"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="543"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="544"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="545"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="546"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="547"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="548"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="549"></td><td><pre></pre></td></tr><tr><td data-num="550"></td><td><pre></pre></td></tr><tr><td data-num="551"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="552"></td><td><pre>     * 根据索引修改 list 中的某条数据</pre></td></tr><tr><td data-num="553"></td><td><pre>     *</pre></td></tr><tr><td data-num="554"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="555"></td><td><pre>     * @param index 索引</pre></td></tr><tr><td data-num="556"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="557"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="558"></td><td><pre>     */</pre></td></tr><tr><td data-num="559"></td><td><pre></pre></td></tr><tr><td data-num="560"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lUpdateIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="561"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="562"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="563"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="564"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="565"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="566"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="567"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="568"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="569"></td><td><pre></pre></td></tr><tr><td data-num="570"></td><td><pre></pre></td></tr><tr><td data-num="571"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="572"></td><td><pre>     * 移除 N 个值为 value</pre></td></tr><tr><td data-num="573"></td><td><pre>     *</pre></td></tr><tr><td data-num="574"></td><td><pre>     * @param key   键</pre></td></tr><tr><td data-num="575"></td><td><pre>     * @param count 移除多少个</pre></td></tr><tr><td data-num="576"></td><td><pre>     * @param value 值</pre></td></tr><tr><td data-num="577"></td><td><pre>     * @return 移除的个数</pre></td></tr><tr><td data-num="578"></td><td><pre>     */</pre></td></tr><tr><td data-num="579"></td><td><pre></pre></td></tr><tr><td data-num="580"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">lRemove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="581"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="582"></td><td><pre>            <span class="token class-name">Long</span> remove <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> count<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="583"></td><td><pre>            <span class="token keyword">return</span> remove<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="584"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="585"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="586"></td><td><pre>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="587"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="588"></td><td><pre></pre></td></tr><tr><td data-num="589"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="590"></td><td><pre></pre></td></tr><tr><td data-num="591"></td><td><pre>    <span class="token comment">// ===============================HyperLogLog=================================</span></pre></td></tr><tr><td data-num="592"></td><td><pre></pre></td></tr><tr><td data-num="593"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">pfadd</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="594"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="595"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="596"></td><td><pre></pre></td></tr><tr><td data-num="597"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">pfcount</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="598"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="599"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="600"></td><td><pre></pre></td></tr><tr><td data-num="601"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pfremove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="602"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="603"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="604"></td><td><pre></pre></td></tr><tr><td data-num="605"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pfmerge</span><span class="token punctuation">(</span><span class="token class-name">String</span> key1<span class="token punctuation">,</span> <span class="token class-name">String</span> key2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="606"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>key1<span class="token punctuation">,</span> key2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="607"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="608"></td><td><pre></pre></td></tr><tr><td data-num="609"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="redisconfig详解"><a class="anchor" href="#redisconfig详解">#</a> Redis.config 详解</h2><blockquote><p>unit 单位</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Redis configuration file example.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Note that in order to read the configuration file, Redis must be</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># started with the file path as first argument:</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># ./redis-server /path/to/redis.conf</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Note on units: when memory size is needed, it is possible to specify</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># it in the usual form of 1k 5GB 4M and so forth:</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 1k => 1000 bytes</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 1kb => 1024 bytes</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 1m => 1000000 bytes</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 1mb => 1024*1024 bytes</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 1g => 1000000000 bytes</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 1gb => 1024*1024*1024 bytes</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># units are case insensitive so 1GB 1Gb 1gB are all the same.</span></pre></td></tr></table></figure><p>units 单位对大小写不敏感</p><blockquote><p>include</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################## INCLUDES ###################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Include one or more other config files here.  This is useful if you</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># have a standard template that goes to all Redis servers but also need</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># to customize a few per-server settings.  Include files can include</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># other files, so use this wisely.</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Note that option "include" won't be rewritten by command "CONFIG REWRITE"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># from admin or Redis Sentinel. Since Redis always uses the last processed</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># line as value of a configuration directive, you'd better put includes</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># at the beginning of this file to avoid overwriting config change at runtime.</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># If instead you are interested in using includes to override configuration</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># options, it is better to use include as the last line.</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># include /path/to/local.conf</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># include /path/to/other.conf</span></pre></td></tr></table></figure><p>包含：可以合并一些其他配置文件</p><blockquote><p>network</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################## NETWORK #####################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># By default, if no "bind" configuration directive is specified, Redis listens</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># for connections from all available network interfaces on the host machine.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># It is possible to listen to just one or multiple selected interfaces using</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># the "bind" configuration directive, followed by one or more IP addresses.</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># Each address can be prefixed by "-", which means that redis will not fail to</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># start if the address is not available. Being not available only refers to</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># addresses that does not correspond to any network interfece. Addresses that</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># are already in use will always fail, and unsupported protocols will always BE</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># silently skipped.</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># Examples:</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># bind 192.168.1.100 10.0.0.1     # listens on two specific IPv4 addresses</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># bind 127.0.0.1 ::1              # listens on loopback IPv4 and IPv6</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># bind * -::*                     # like the default, all available interfaces</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># internet, binding to all the interfaces is dangerous and will expose the</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># instance to everybody on the internet. So by default we uncomment the</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># following bind directive, that will force Redis to listen only on the</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># IPv4 and IPv6 (if available) loopback interface addresses (this means Redis</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># will only be able to accept client connections from the same host that it is</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># running on).</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># JUST COMMENT OUT THE FOLLOWING LINE.</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1 -::1 <span class="token comment"># 绑定的 ip</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># Protected mode is a layer of security protection, in order to avoid that</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># Redis instances left open on the internet are accessed and exploited.</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># When protected mode is on and if:</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># 1) The server is not binding explicitly to a set of addresses using the</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">#    "bind" directive.</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># 2) No password is configured.</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># The server only accepts connections from clients connecting from the</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># sockets.</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># By default protected mode is enabled. You should disable it only if</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment"># you are sure you want clients from other hosts to connect to Redis</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment"># even if no authentication is configured, nor a specific set of interfaces</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># are explicitly listed using the "bind" directive.</span></pre></td></tr><tr><td data-num="49"></td><td><pre>protected-mode <span class="token function">yes</span> <span class="token comment"># 是否受保护的模式</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment"># Accept connections on the specified port, default is 6379 (IANA #815344).</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment"># If port 0 is specified Redis will not listen on a TCP socket.</span></pre></td></tr><tr><td data-num="53"></td><td><pre>port <span class="token number">6379</span> <span class="token comment"># 修改端口</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># TCP listen() backlog.</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment"># In high requests-per-second environments you need a high backlog in order</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment"># to avoid slow clients connection issues. Note that the Linux kernel</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># will silently truncate it to the value of /proc/sys/net/core/somaxconn so</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># make sure to raise both the value of somaxconn and tcp_max_syn_backlog</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># in order to get the desired effect.</span></pre></td></tr><tr><td data-num="62"></td><td><pre>tcp-backlog <span class="token number">511</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment"># Unix socket.</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment"># Specify the path for the Unix socket that will be used to listen for</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment"># incoming connections. There is no default, so Redis will not listen</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># on a unix socket when not specified.</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment"># unixsocket /run/redis.sock</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment"># unixsocketperm 700</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment"># Close the connection after a client is idle for N seconds (0 to disable)</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token function">timeout</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment"># TCP keepalive.</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment"># of communication. This is useful for two reasons:</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># 1) Detect dead peers.</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># 2) Force network equipment in the middle to consider the connection to be</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment">#    alive.</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># On Linux, the specified value (in seconds) is the period used to send ACKs.</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment"># Note that to close the connection the double of the time is needed.</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># On other kernels the period depends on the kernel configuration.</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment"># A reasonable value for this option is 300 seconds, which is the new</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># Redis default starting with Redis 3.2.1.</span></pre></td></tr><tr><td data-num="91"></td><td><pre>tcp-keepalive <span class="token number">300</span></pre></td></tr></table></figure><blockquote><p>通用</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################# GENERAL #####################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># By default Redis does not run as a daemon. Use 'yes' if you need it.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># When Redis is supervised by upstart or systemd, this parameter has no impact.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>daemonize <span class="token function">yes</span> <span class="token comment"># 以守护进程模式运行，即后台运行。默认为 No，需要修改为 yes。</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># If you run Redis from upstart or systemd, Redis can interact with your</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># supervision tree. Options:</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#   supervised no      - no supervision interaction</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#   supervised upstart - signal upstart by putting Redis into SIGSTOP mode</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#                        requires "expect stop" in your upstart job config</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#   supervised systemd - signal systemd by writing READY=1 to $NOTIFY_SOCKET</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#                        on startup, and updating Redis status on a regular</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#                        basis.</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#   supervised auto    - detect upstart or systemd method based on</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#                        UPSTART_JOB or NOTIFY_SOCKET environment variables</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># Note: these supervision methods only signal "process is ready."</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#       They do not enable continuous pings back to your supervisor.</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># The default is "no". To run under upstart/systemd, you can simply uncomment</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># the line below:</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># supervised auto</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># If a pid file is specified, Redis writes it where specified at startup</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># and removes it at exit.</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># When the server runs non daemonized, no pid file is created if none is</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># specified in the configuration. When the server is daemonized, the pid file</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># is used even if not specified, defaulting to "/var/run/redis.pid".</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># Creating a pid file is best effort: if Redis is not able to create it</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># nothing bad happens, the server will start and run normally.</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># Note that on modern Linux systems "/run/redis.pid" is more conforming</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># and should be used instead.</span></pre></td></tr><tr><td data-num="38"></td><td><pre>pidfile /var/run/redis_6379.pid <span class="token comment"># 如果以后台方式运行，我们需要指定一个 pid 进程文件</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># Specify the server verbosity level.</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># This can be one of:</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># debug (a lot of information, useful for development/testing)</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># verbose (many rarely useful info, but not a mess like the debug level)</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># notice (moderately verbose, what you want in production probably) 生产环境使用</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># warning (only very important /critical messages are logged) 非常关键的信息被记录</span></pre></td></tr><tr><td data-num="46"></td><td><pre>loglevel notice <span class="token comment"># 日志级别</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># Specify the log file name. Also the empty string can be used to force</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment"># Redis to log on the standard output. Note that if you use standard</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment"># output for logging but daemonize, logs will be sent to /dev/null</span></pre></td></tr><tr><td data-num="51"></td><td><pre>logfile <span class="token string">""</span> <span class="token comment"># 日志生成位置与文件名 为空则输出到标准输出</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># To enable logging to the system logger, just set 'syslog-enabled' to yes,</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment"># and optionally update the other syslog parameters to suit your needs.</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># syslog-enabled no</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment"># Specify the syslog identity.</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment"># syslog-ident redis</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7.</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># syslog-facility local0</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment"># To disable the built in crash log, which will possibly produce cleaner core</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment"># dumps when they are needed, uncomment the following:</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment"># crash-log-enabled no</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># To disable the fast memory check that's run as part of the crash log, which</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment"># will possibly let redis terminate sooner, uncomment the following:</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment"># crash-memcheck-enabled no</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment"># Set the number of databases. The default database is DB 0, you can select</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment"># a different one on a per-connection basis using SELECT &lt;dbid> where</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment"># dbid is a number between 0 and 'databases'-1</span></pre></td></tr><tr><td data-num="76"></td><td><pre>databases <span class="token number">16</span> <span class="token comment"># 数据库数量 默认为 16 个 </span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># By default Redis shows an ASCII art logo only when started to log to the</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment"># standard output and if the standard output is a TTY and syslog logging is</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment"># disabled. Basically this means that normally a logo is displayed only in</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># interactive sessions.</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment"># However it is possible to force the pre-4.0 behavior and always show a</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment"># ASCII art logo in startup logs by setting the following option to yes.</span></pre></td></tr><tr><td data-num="85"></td><td><pre>always-show-logo no <span class="token comment"># 是否总是显示 logo</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># By default, Redis modifies the process title (as seen in 'top' and 'ps') to</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># provide some runtime information. It is possible to disable this and leave</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment"># the process name as executed by setting the following to no.</span></pre></td></tr><tr><td data-num="90"></td><td><pre>set-proc-title <span class="token function">yes</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># When changing the process title, Redis uses the following template to construct</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment"># the modified title.</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># Template variables are specified in curly brackets. The following variables are</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment"># supported:</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token comment"># &#123;title&#125;           Name of process as executed if parent, or type of child process.</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment"># &#123;listen-addr&#125;     Bind address or '*' followed by TCP or TLS port listening on, or</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment">#                   Unix socket if only that's available.</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token comment"># &#123;server-mode&#125;     Special mode, i.e. "[sentinel]" or "[cluster]".</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment"># &#123;port&#125;            TCP port listening on, or 0.</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment"># &#123;tls-port&#125;        TLS port listening on, or 0.</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment"># &#123;unixsocket&#125;      Unix domain socket listening on, or "".</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment"># &#123;config-file&#125;     Name of configuration file used.</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="107"></td><td><pre>proc-title-template <span class="token string">"&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;"</span></pre></td></tr></table></figure><blockquote><p>快照</p></blockquote><p>持久化，在规定的时间内，执行了多少次操作，则会持久化到文件 <code>.rdb .aof</code></p><p>redis 为内存数据库，没有持久化，断电数据就会消失</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################ SNAPSHOTTING  ################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Save the DB to disk.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># save &lt;seconds> &lt;changes></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># Redis will save the DB if both the given number of seconds and the given</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># number of write operations against the DB occurred.</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># Snapshotting can be completely disabled with a single empty string argument</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># as in following example:</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># save ""</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># Unless specified otherwise, by default Redis will save the DB:</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># =================================================================</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#   * After 3600 seconds (an hour) if at least 1 key changed</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#   * After 300 seconds (5 minutes) if at least 100 keys changed</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#   * After 60 seconds if at least 10000 keys changed</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># =================================================================</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># You can set these explicitly by uncommenting the three following lines.</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># save 3600 1</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># save 300 100</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># save 60 10000</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 通过 save 配置自动持久化规则</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># By default Redis will stop accepting writes if RDB snapshots are enabled</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># (at least one save point) and the latest background save failed.</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># This will make the user aware (in a hard way) that data is not persisting</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># on disk properly, otherwise chances are that no one will notice and some</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># disaster will happen.</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># If the background saving process will start working again Redis will</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># automatically allow writes again.</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># However if you have setup your proper monitoring of the Redis server</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># and persistence, you may want to disable this feature so that Redis will</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># continue to work as usual even if there are problems with disk,</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># permissions, and so forth.</span></pre></td></tr><tr><td data-num="42"></td><td><pre>stop-writes-on-bgsave-error <span class="token function">yes</span> <span class="token comment"># 持久化出现错误后是否继续工作</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># Compress string objects using LZF when dump .rdb databases?</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># By default compression is enabled as it's almost always a win.</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment"># If you want to save some CPU in the saving child set it to 'no' but</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment"># the dataset will likely be bigger if you have compressible values or keys.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>rdbcompression <span class="token function">yes</span> <span class="token comment"># 是否压缩.rdb 文件 需要消耗一定的 cpu 资源</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment"># Since version 5 of RDB a CRC64 checksum is placed at the end of the file.</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment"># This makes the format more resistant to corruption but there is a performance</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment"># hit to pay (around 10%) when saving and loading RDB files, so you can disable it</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># for maximum performances.</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># RDB files created with checksum disabled have a checksum of zero that will</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment"># tell the loading code to skip the check.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>rdbchecksum <span class="token function">yes</span> <span class="token comment"># 是否校验.rdb 文件 </span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># Enables or disables full sanitation checks for ziplist and listpack etc when</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># loading an RDB or RESTORE payload. This reduces the chances of a assertion or</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># crash later on while processing commands.</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment"># Options:</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">#   no         - Never perform full sanitation</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">#   yes        - Always perform full sanitation</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">#   clients    - Perform full sanitation only for user connections.</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment">#                Excludes: RDB files, RESTORE commands received from the master</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">#                connection, and client connections which have the</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment">#                skip-sanitize-payload ACL flag.</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment"># The default should be 'clients' but since it currently affects cluster</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment"># resharding via MIGRATE, it is temporarily set to 'no' by default.</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment"># sanitize-dump-payload no</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment"># The filename where to dump the DB</span></pre></td></tr><tr><td data-num="75"></td><td><pre>dbfilename dump.rdb </pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment"># Remove RDB files used by replication in instances without persistence</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># enabled. By default this option is disabled, however there are environments</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment"># where for regulations or other security concerns, RDB files persisted on</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment"># disk by masters in order to feed replicas, or stored on disk by replicas</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># in order to load them for the initial synchronization, should be deleted</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># ASAP. Note that this option ONLY WORKS in instances that have both AOF</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment"># and RDB persistence disabled, otherwise is completely ignored.</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># An alternative (and sometimes better) way to obtain the same effect is</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment"># to use diskless replication on both master and replicas instances. However</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># in the case of replicas, diskless is not always an option.</span></pre></td></tr><tr><td data-num="88"></td><td><pre>rdb-del-sync-files no</pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># The working directory.</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># The DB will be written inside this directory, with the filename specified</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment"># above using the 'dbfilename' configuration directive.</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># The Append Only File will also be created inside this directory.</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># Note that you must specify a directory here, not a file name.</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token function">dir</span> ./ <span class="token comment"># 持久化文件保存目录</span></pre></td></tr></table></figure><blockquote><p>安全</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################## SECURITY ###################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Warning: since Redis is pretty fast, an outside user can try up to</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 1 million passwords per second against a modern box. This means that you</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># should use very strong passwords, otherwise they will be very easy to break.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Note that because the password is really a shared secret between the client</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># and the server, and should not be memorized by any human, the password</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># can be easily a long string from /dev/urandom or whatever, so by using a</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># long and unguessable password no brute force attack will be possible.</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># Redis ACL users are defined in the following format:</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#   user &lt;username> ... acl rules ...</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># For example:</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#   user worker +@list +@connection ~jobs:* on >ffa9203c493aa99</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># The special username "default" is used for new connections. If this user</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># has the "nopass" rule, then new connections will be immediately authenticated</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># as the "default" user without the need of any password provided via the</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># AUTH command. Otherwise if the "default" user is not flagged with "nopass"</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># the connections will start in not authenticated state, and will require</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># AUTH (or the HELLO command AUTH option) in order to be authenticated and</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># start to work.</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># The ACL rules that describe what a user can do are the following:</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#  on           Enable the user: it is possible to authenticate as this user.</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#  off          Disable the user: it's no longer possible to authenticate</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">#               with this user, however the already authenticated connections</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#               will still work.</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">#  skip-sanitize-payload    RESTORE dump-payload sanitation is skipped.</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">#  sanitize-payload         RESTORE dump-payload is sanitized (default).</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#  +&lt;command>   Allow the execution of that command</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#  -&lt;command>   Disallow the execution of that command</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">#  +@&lt;category> Allow the execution of all the commands in such category</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">#               with valid categories are like @admin, @set, @sortedset, ...</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">#               and so forth, see the full list in the server.c file where</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">#               the Redis command table is described and defined.</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">#               The special category @all means all the commands, but currently</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">#               present in the server, and that will be loaded in the future</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">#               via modules.</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">#  +&lt;command>|subcommand    Allow a specific subcommand of an otherwise</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">#                           disabled command. Note that this form is not</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">#                           allowed as negative like -DEBUG|SEGFAULT, but</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">#                           only additive starting with "+".</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">#  allcommands  Alias for +@all. Note that it implies the ability to execute</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">#               all the future commands loaded via the modules system.</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">#  nocommands   Alias for -@all.</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">#  ~&lt;pattern>   Add a pattern of keys that can be mentioned as part of</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">#               commands. For instance ~* allows all the keys. The pattern</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#               is a glob-style pattern like the one of KEYS.</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">#               It is possible to specify multiple patterns.</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">#  allkeys      Alias for ~*</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">#  resetkeys    Flush the list of allowed keys patterns.</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">#  &amp;&lt;pattern>   Add a glob-style pattern of Pub/Sub channels that can be</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">#               accessed by the user. It is possible to specify multiple channel</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment">#               patterns.</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment">#  allchannels  Alias for &amp;*</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">#  resetchannels            Flush the list of allowed channel patterns.</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">#  >&lt;password>  Add this password to the list of valid password for the user.</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">#               For example >mypass will add "mypass" to the list.</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">#               This directive clears the "nopass" flag (see later).</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">#  &lt;&lt;password>  Remove this password from the list of valid passwords.</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment">#  nopass       All the set passwords of the user are removed, and the user</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">#               is flagged as requiring no password: it means that every</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment">#               password will work against this user. If this directive is</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">#               used for the default user, every new connection will be</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment">#               immediately authenticated with the default user without</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">#               any explicit AUTH command required. Note that the "resetpass"</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment">#               directive will clear this condition.</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment">#  resetpass    Flush the list of allowed passwords. Moreover removes the</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">#               "nopass" status. After "resetpass" the user has no associated</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment">#               passwords and there is no way to authenticate without adding</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment">#               some password (or setting it as "nopass" later).</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment">#  reset        Performs the following actions: resetpass, resetkeys, off,</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment">#               -@all. The user returns to the same state it has immediately</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment">#               after its creation.</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># ACL rules can be specified in any order: for instance you can start with</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># passwords, then flags, or key patterns. However note that the additive</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment"># and subtractive rules will CHANGE MEANING depending on the ordering.</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment"># For instance see the following example:</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment">#   user alice on +@all -DEBUG ~* >somepassword</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># This will allow "alice" to use all the commands with the exception of the</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment"># DEBUG command, since +@all added all the commands to the set of the commands</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># alice can use, and later DEBUG was removed. However if we invert the order</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment"># of two ACL rules the result will be different:</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment">#   user alice on -DEBUG +@all ~* >somepassword</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># Now DEBUG was removed when alice had yet no commands in the set of allowed</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment"># commands, later all the commands are added, so the user will be able to</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># execute everything.</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment"># Basically ACL rules are processed left-to-right.</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token comment"># For more information about ACL configuration please refer to</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment"># the Redis web site at https://redis.io/topics/acl</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment"># ACL LOG</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment"># The ACL Log tracks failed commands and authentication events associated</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment"># with ACLs. The ACL Log is useful to troubleshoot failed commands blocked </span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token comment"># by ACLs. The ACL Log is stored in memory. You can reclaim memory with </span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token comment"># ACL LOG RESET. Define the maximum entry length of the ACL Log below.</span></pre></td></tr><tr><td data-num="110"></td><td><pre>acllog-max-len <span class="token number">128</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token comment"># Using an external ACL file</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token comment"># Instead of configuring users here in this file, it is possible to use</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token comment"># a stand-alone file just listing users. The two methods cannot be mixed:</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># if you configure users here and at the same time you activate the external</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment"># ACL file, the server will refuse to start.</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token comment"># The format of the external ACL user file is exactly the same as the</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment"># format that is used inside redis.conf to describe users.</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment"># aclfile /etc/redis/users.acl</span></pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment"># IMPORTANT NOTE: starting with Redis 6 "requirepass" is just a compatibility</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token comment"># layer on top of the new ACL system. The option effect will be just setting</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token comment"># the password for the default user. Clients will still authenticate using</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment"># AUTH &lt;password> as usually, or more explicitly with AUTH default &lt;password></span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token comment"># if they follow the new protocol: both will work.</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment"># The requirepass is not compatable with aclfile option and the ACL LOAD</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token comment"># command, these will cause requirepass to be ignored.</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment"># requirepass foobared</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token comment"># 为 redis 设置链接密码 默认是没有密码的</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment"># New users are initialized with restrictive permissions by default, via the</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token comment"># equivalent of this ACL rule 'off resetkeys -@all'. Starting with Redis 6.2, it</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token comment"># is possible to manage access to Pub/Sub channels with ACL rules as well. The</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token comment"># default Pub/Sub channels permission if new users is controlled by the </span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token comment"># acl-pubsub-default configuration directive, which accepts one of these values:</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token comment"># allchannels: grants access to all Pub/Sub channels</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token comment"># resetchannels: revokes access to all Pub/Sub channels</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token comment"># To ensure backward compatibility while upgrading Redis 6.0, acl-pubsub-default</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token comment"># defaults to the 'allchannels' permission.</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token comment"># Future compatibility note: it is very likely that in a future version of Redis</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token comment"># the directive's default of 'allchannels' will be changed to 'resetchannels' in</span></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token comment"># order to provide better out-of-the-box Pub/Sub security. Therefore, it is</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token comment"># recommended that you explicitly define Pub/Sub permissions for all users</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token comment"># rather then rely on implicit default values. Once you've set explicit</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token comment"># Pub/Sub for all existing users, you should uncomment the following line.</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token comment"># acl-pubsub-default resetchannels</span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token comment"># Command renaming (DEPRECATED).</span></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token comment"># ------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token comment"># WARNING: avoid using this option if possible. Instead use ACLs to remove</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token comment"># commands from the default user, and put them only in some admin user you</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token comment"># create for administrative purposes.</span></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token comment"># ------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token comment"># It is possible to change the name of dangerous commands in a shared</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token comment"># environment. For instance the CONFIG command may be renamed into something</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token comment"># hard to guess so that it will still be available for internal-use tools</span></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token comment"># but not available for general clients.</span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token comment"># Example:</span></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="172"></td><td><pre><span class="token comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token comment"># It is also possible to completely kill a command by renaming it into</span></pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token comment"># an empty string:</span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token comment"># rename-command CONFIG ""</span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token comment"># Please note that changing the name of commands that are logged into the</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token comment"># AOF file or transmitted to replicas may cause problems.</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config get requirepass <span class="token comment"># 获取当前密码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"requirepass"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config <span class="token builtin class-name">set</span> requirepass <span class="token string">"123456"</span> <span class="token comment"># 设置密码</span></pre></td></tr><tr><td data-num="5"></td><td><pre>OK</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config get requirepass </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>error<span class="token punctuation">)</span> NOAUTH Authentication required. <span class="token comment"># 未认证 无权限操作</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> auth <span class="token number">123456</span> <span class="token comment"># 认证</span></pre></td></tr><tr><td data-num="9"></td><td><pre>OK</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config get requirepass <span class="token comment"># 重写获取权限</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"requirepass"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"123456"</span></pre></td></tr></table></figure><blockquote><p>限制客户端</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################### CLIENTS ####################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Set the max number of connected clients at the same time. By default</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># this limit is set to 10000 clients, however if the Redis server is not</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># able to configure the process file limit to allow for the specified limit</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># the max number of allowed clients is set to the current file limit</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># minus 32 (as Redis reserves a few file descriptors for internal uses).</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># Once the limit is reached Redis will close all the new connections sending</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># an error 'max number of clients reached'.</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># IMPORTANT: When Redis Cluster is used, the max number of connections is also</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># shared with the cluster bus: every node in the cluster will use two</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># connections, one incoming and another outgoing. It is important to size the</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># limit accordingly in case of very large clusters.</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># maxclients 10000</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 设置链接 redis 最大客户端数量</span></pre></td></tr></table></figure><h2 id="redis持久化"><a class="anchor" href="#redis持久化">#</a> Redis 持久化</h2><p>Redis 是内存数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失。所以 Redis 提供了持久化功能！</p><h3 id="rdbredis-database"><a class="anchor" href="#rdbredis-database">#</a> RDB(Redis Database)</h3><p><img data-src="/image-20210808095739650.png" alt="image-20210808095739650"></p><p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的 Snapshot 快照，它恢复时是将快照文件直接读到内存里。</p><p>Redis 会单独创建 (fork) 一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何 I0 操作的。这就确保了极高的性能。如果需要进行<strong>大规模数据的恢复</strong>，且<strong>对于数据恢复的完整性不是非常敏感</strong>，那 RDB 方式要比 AOF 方式<strong>更加的高效</strong>。RDB 的缺点是<strong>最后一次持久化后的数据可能丢失</strong>。</p><p><mark>RDB 为默认持久化方式</mark></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># The filename where to dump the DB</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dbfilename dump.rdb <span class="token comment"># 默认保存的文件名为 dump.rdb</span></pre></td></tr></table></figure><blockquote><p>save</p></blockquote><p>通过 save 设置保存策略</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Save the DB to disk.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># save &lt;seconds> &lt;changes></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># Redis will save the DB if both the given number of seconds and the given</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># number of write operations against the DB occurred.</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Snapshotting can be completely disabled with a single empty string argument</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># as in following example:</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># save ""</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># Unless specified otherwise, by default Redis will save the DB:</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#   * After 3600 seconds (an hour) if at least 1 key changed</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#   * After 300 seconds (5 minutes) if at least 100 keys changed</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#   * After 60 seconds if at least 10000 keys changed</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># You can set these explicitly by uncommenting the three following lines.</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># save 3600 1</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># save 300 100</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># save 60 10000</span></pre></td></tr></table></figure><p><strong>触发机制:</strong></p><ul><li>save 策略满足的条件下，会自动触发 rdb 规则</li><li>执行 flushall 命令后，也会触发 rdb 规则</li><li>退出 redis, 也会产生 rdb 文件</li></ul><p>备份就自动生成一个 dump.rdb 文件</p><p><strong>恢复 rdb 文件</strong></p><ol><li><p>将 rdb 文件放在 redis 启动目录就可以了，redis 在启动时会自动检测 dump.rdb 恢复其中数据</p></li><li><p>查看 rdb 文件需要放置的位置</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config get <span class="token function">dir</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"dir"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"/home/qwqq"</span> <span class="token comment"># 如果这个目录下存在 dump.rdb 文件 启动就会自动恢复其中数据</span></pre></td></tr></table></figure></li></ol><p><strong>默认配置就很够用了</strong></p><blockquote><p>优缺点</p></blockquote><ul><li>优点<ul><li>适合大规模的数据恢复！</li><li>对数据完整性要求不高！</li></ul></li><li>缺点<ul><li>需要一定时间间隔进程操作！如果 redis 意外宕机了，最后一次修改的数据就没了</li><li>fork 进程的时候，会占用一定 cpu 资源</li></ul></li></ul><h3 id="aofappend-only-file"><a class="anchor" href="#aofappend-only-file">#</a> AOF(Append Only File)</h3><p>将我们所有命令全部记录下来，history, 恢复的时候将整个文件再执行一遍</p><p><img data-src="/image-20210808104051456.png" alt="image-20210808104051456"></p><p>以日志的形式来记录每个<strong>写操作</strong>，将 Redis 执行过的所有指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p><p><mark>Aof 保存的是 appendonly.aof 文件</mark></p><p>配置:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">############################## APPEND ONLY MODE ###############################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># By default Redis asynchronously dumps the dataset on disk. This mode is</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># good enough in many applications, but an issue with the Redis process or</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># a power outage may result into a few minutes of writes lost (depending on</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># the configured save points).</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># The Append Only File is an alternative persistence mode that provides</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># much better durability. For instance using the default data fsync policy</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># (see later in the config file) Redis can lose just one second of writes in a</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># dramatic event like a server power outage, or a single write if something</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># wrong with the Redis process itself happens, but the operating system is</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># still running correctly.</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># AOF and RDB persistence can be enabled at the same time without problems.</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># with the better durability guarantees.</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># Please check https://redis.io/topics/persistence for more information.</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>appendonly no <span class="token comment"># 是否开启 AOF 默认是不开启的</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># The name of the append only file (default: "appendonly.aof")</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>appendfilename <span class="token string">"appendonly.aof"</span> <span class="token comment"># 输出文件名</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># The fsync() call tells the Operating System to actually write data on disk</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># instead of waiting for more data in the output buffer. Some OS will really flush</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># data on disk, some other OS will just try to do it ASAP.</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># Redis supports three different modes:</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># no: don't fsync, just let the OS flush the data when it wants. Faster.</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># always: fsync after every write to the append only log. Slow, Safest.</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># everysec: fsync only one time every second. Compromise.</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># The default is "everysec", as that's usually the right compromise between</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># speed and data safety. It's up to you to understand if you can relax this to</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># "no" that will let the operating system flush the output buffer when</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># it wants, for better performances (but if you can live with the idea of</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># some data loss consider the default persistence mode that's snapshotting),</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># or on the contrary, use "always" that's very slow but a bit safer than</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># everysec.</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># More details please check the following article:</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment"># http://antirez.com/post/redis-persistence-demystified.html</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># If unsure, use "everysec".</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment"># 持久化策略</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment"># appendfsync always # 每次修改内存中的 data 都会将.aof 写入磁盘</span></pre></td></tr><tr><td data-num="52"></td><td><pre>appendfsync everysec <span class="token comment"># 每秒将.aof 文件写入磁盘一次</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># appendfsync no # 让 OS 自己决定什么时候将.aof 写入磁盘</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># When the AOF fsync policy is set to always or everysec, and a background</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment"># saving process (a background save or AOF log background rewriting) is</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment"># performing a lot of I/O against the disk, in some Linux configurations</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment"># Redis may block too long on the fsync() call. Note that there is no fix for</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># this currently, as even performing fsync in a different thread will block</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># our synchronous write(2) call.</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment"># In order to mitigate this problem it's possible to use the following option</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment"># that will prevent fsync() from being called in the main process while a</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment"># BGSAVE or BGREWRITEAOF is in progress.</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment"># This means that while another child is saving, the durability of Redis is</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment"># the same as "appendfsync none". In practical terms, this means that it is</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># possible to lose up to 30 seconds of log in the worst scenario (with the</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment"># default Linux settings).</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment"># If you have latency problems turn this to "yes". Otherwise leave it as</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment"># "no" that is the safest pick from the point of view of durability.</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>no-appendfsync-on-rewrite no</pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment"># Automatic rewrite of the append only file.</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment"># Redis is able to automatically rewrite the log file implicitly calling</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment"># This is how it works: Redis remembers the size of the AOF file after the</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment"># latest rewrite (if no rewrite has happened since the restart, the size of</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># the AOF at startup is used).</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment"># This base size is compared to the current size. If the current size is</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># bigger than the specified percentage, the rewrite is triggered. Also</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment"># you need to specify a minimal size for the AOF file to be rewritten, this</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># is useful to avoid rewriting the AOF file even if the percentage increase</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># is reached but it is still pretty small.</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># Specify a percentage of zero in order to disable the automatic AOF</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment"># rewrite feature.</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>auto-aof-rewrite-percentage <span class="token number">100</span></pre></td></tr><tr><td data-num="94"></td><td><pre>auto-aof-rewrite-min-size 64mb</pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># 当文件过大时（超过 64mb），就会 fork 一个新的线程，来将我们的文件进行重写</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># An AOF file may be found to be truncated at the end during the Redis</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token comment"># startup process, when the AOF data gets loaded back into memory.</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment"># This may happen when the system where Redis is running</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment"># crashes, especially when an ext4 filesystem is mounted without the</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token comment"># data=ordered option (however this can't happen when Redis itself</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment"># crashes or aborts but the operating system still works correctly).</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment"># Redis can either exit with an error when this happens, or load as much</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment"># data as possible (the default now) and start if the AOF file is found</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment"># to be truncated at the end. The following option controls this behavior.</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token comment"># If aof-load-truncated is set to yes, a truncated AOF file is loaded and</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token comment"># the Redis server starts emitting a log to inform the user of the event.</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token comment"># Otherwise if the option is set to no, the server aborts with an error</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token comment"># and refuses to start. When the option is set to no, the user requires</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token comment"># to fix the AOF file using the "redis-check-aof" utility before to restart</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment"># the server.</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token comment"># Note that if the AOF file will be found to be corrupted in the middle</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># the server will still exit with an error. This option only applies when</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment"># Redis will try to read more data from the AOF file but not enough bytes</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token comment"># will be found.</span></pre></td></tr><tr><td data-num="119"></td><td><pre>aof-load-truncated <span class="token function">yes</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment"># When rewriting the AOF file, Redis is able to use an RDB preamble in the</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment"># AOF file for faster rewrites and recoveries. When this option is turned</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment"># on the rewritten AOF file is composed of two different stanzas:</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token comment">#   [RDB file][AOF tail]</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment"># When loading, Redis recognizes that the AOF file starts with the "REDIS"</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token comment"># string and loads the prefixed RDB file, then continues loading the AOF</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token comment"># tail.</span></pre></td></tr><tr><td data-num="130"></td><td><pre>aof-use-rdb-preamble <span class="token function">yes</span></pre></td></tr></table></figure><p>如果这个 aof 文件有错位，这时候 redis 是启动不起来的，我们需要修复这个 aof 文件</p><p>redis 给我们提供了一个工具 <code>redis-check-aof --fix filename</code></p><blockquote><p>优缺点</p></blockquote><ul><li>优点<ul><li>每一次修改都同步，文件的完整性会更加好</li><li>每秒同步一次，可能会丢失一秒的数据</li><li>从不同步，效率是最高的</li></ul></li><li>缺点<ul><li>相对于数据文件来说，aof 远远大于 rdb，修复的速度也比 rdb 慢</li><li>aof 运行效率也比 rdb 慢，所以我们 redis 默认配置就是 rdb 持久化</li></ul></li></ul><h3 id="小结"><a class="anchor" href="#小结">#</a> 小结</h3><ol><li>RDB 持久化方式能够在指定的时间间隔内对你的数据进行快照存储</li><li>AOF 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF 命令以 Redis 协议追加保存每次写的操作到文件末尾，Redis 还能对 AOF 文件进行后台重写，使得 AOF 文件的体积不至于过大。</li><li><mark>只做缓存，如果你只希望你的数据在服务器运行的时候存在，你也可以不使用任何持久化</mark></li><li>同时开启两种持久化方式<ul><li>在这种情况下，当 redis 重启的时候会优先载入 AOF 文件来恢复原始的数据，因为在通常情况下 AOF 文件保存的数据集要比 RDB 文件保存的数据集要完整。</li><li>RDB 的数据不实时，同时使用两者时服务器重启也只会找 AOF 文件，那要不要只使用 AOF 呢？作者建议不要，因为 RDB 更适合用于备份数据库（AOF 在不断变化不好备份），快速重启，而且不会有 AOF 可能潜在的 Bug，留着作为一个万一的手段。</li></ul></li><li>性能建议<ul><li>因为 RDB 文件只用作后备用途，建议只在 Slave 上持久化 RDB 文件，而且只要 15 分钟备份一次就够了，只保留 save 900 1 这条规则。</li><li>如果 Enable AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只 load 自己的 AOF 文件就可以了，代价一是带来了持续的 IO，二是 AOF rewrite 的最后将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少 AOF rewrite 的频率，AOF 重写的基础大小默认值 64M 太小了，可以设到 5G 以上，默认超过原大小 100% 大小重写可以改到适当的数值。</li><li>如果不 Enable AOF，仅靠 Master-Slave Replcation 实现高可用性也可以，能省掉一大第 lO，也减少了 rewrite 时带来的系统波动。代价是如果 Master/Slave 同时倒掉，会丢失十几分钟的数据，启动脚本也要比较两个 Master/Slave 中的 RDB 文件，载入较新的那个，微博就是这种架构。</li></ul></li></ol><h2 id="redis发布订阅"><a class="anchor" href="#redis发布订阅">#</a> Redis 发布订阅</h2><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式∶发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p><p>Redis 客户端可以订阅任意数量的频道。</p><p>订阅 / 发布消息图:</p><p><img data-src="/image-20210808151612425.png" alt="image-20210808151612425"></p><blockquote><p>命令</p></blockquote><p><img data-src="/image-20210808151901107.png" alt="image-20210808151901107"></p><h2 id="redis主从复制"><a class="anchor" href="#redis主从复制">#</a> Redis 主从复制</h2><h3 id="概念"><a class="anchor" href="#概念">#</a> 概念</h3><p>主从复制，是指将一台 Redis 服务器的数据，复制到其他的 Redis 服务器。前者称为主节点 (masterleader)，后者称为从节点 (slave/follower); 数据的复制是单向的，只能由主节点到从节点。Master 以写为主，Slave 以读为主。</p><p>默认情况下，每台 Redis 服务器都是主节点；且一个主节点可以有多个从节点 (或没有从节点)，但一个从节点只能有一个主节点。</p><p><strong>主从复制的作用主要包括:</strong></p><ol><li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</li><li>故障恢复∶当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</li><li>负载均衡∶在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写 Redis 数据时应用连接主节点，读 Redis 数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量。</li><li>高可用 (集群) 基石∶除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是 Redis 高可用的基础。</li></ol><p>一般来说，要将 Redis 运用于工程项目中，只使用一台 Redis 是万万不能的，原因如下:</p><ol><li>从结构上，单个 Redis 服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；</li><li>从容量上，单个 Redis 服务器内存容量有限，就算一台 Redis 服务器内存容量为 256G，也不能将所有内存用作 Redis 存储内存，一般来说，<mark>单台 Redis 最大使用内存不应该超过 20G</mark>。</li></ol><p>主从复制，读写分离！80% 的情况下都是在进行读操作！减缓服务器的压力！架构中经常使用！一主二从！</p><p>只要在公司中，主从复制就是必须要使用的，因为在真实的项目中不可能单机使用 Redis !</p><h3 id="配置环境"><a class="anchor" href="#配置环境">#</a> 配置环境</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info replication <span class="token comment"># 查看主从信息</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># Replication</span></pre></td></tr><tr><td data-num="3"></td><td><pre>role:master <span class="token comment"># 角色 主机</span></pre></td></tr><tr><td data-num="4"></td><td><pre>connected_slaves:0 <span class="token comment"># 已连接从机数量</span></pre></td></tr><tr><td data-num="5"></td><td><pre>master_failover_state:no-failover</pre></td></tr><tr><td data-num="6"></td><td><pre>master_replid:c5f8a25b64443f1222526c5b7a5689c620514488</pre></td></tr><tr><td data-num="7"></td><td><pre>master_replid2:0000000000000000000000000000000000000000</pre></td></tr><tr><td data-num="8"></td><td><pre>master_repl_offset:0</pre></td></tr><tr><td data-num="9"></td><td><pre>second_repl_offset:-1</pre></td></tr><tr><td data-num="10"></td><td><pre>repl_backlog_active:0</pre></td></tr><tr><td data-num="11"></td><td><pre>repl_backlog_size:1048576</pre></td></tr><tr><td data-num="12"></td><td><pre>repl_backlog_first_byte_offset:0</pre></td></tr><tr><td data-num="13"></td><td><pre>repl_backlog_histlen:0</pre></td></tr></table></figure><ol><li><p>复制配置文件</p></li><li><p>修改以下内容</p><ul><li>端口</li><li>pid 名字</li><li>log 文件名</li><li>.rdb 文件名</li></ul></li><li><p>以不同配置文件启动 redis-server</p></li><li><p>从机设置主机</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>slaveof 主机ip 主机端口</pre></td></tr></table></figure></li></ol><p>配置完后效果如图:&lt;img src=&quot;Redis/image-20210808161240674.png&quot; alt=&quot;image-20210808161240674&quot; style=&quot;zoom:50%;&quot; /&gt;</p><p>此时主从通过命令配置，为暂时配置，重启后会失效.</p><p><strong>通过配置文件配置:</strong></p><p>redis.conf</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">################################# REPLICATION #################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># another Redis server. A few things to understand ASAP about Redis replication.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#   +------------------+      +---------------+</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#   |      Master      | ---> |    Replica    |</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#   | (receive writes) |      |  (exact copy) |</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#   +------------------+      +---------------+</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 1) Redis replication is asynchronous, but you can configure a master to</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#    stop accepting writes if it appears to be not connected with at least</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#    a given number of replicas.</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 2) Redis replicas are able to perform a partial resynchronization with the</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#    master if the replication link is lost for a relatively small amount of</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#    time. You may want to configure the replication backlog size (see the next</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#    sections of this file) with a sensible value depending on your needs.</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 3) Replication is automatic and does not need user intervention. After a</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#    network partition replicas automatically try to reconnect to masters</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#    and resynchronize with them.</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># replicaof &lt;masterip> &lt;masterport></span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 从机需要配置此处</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># If the master is password protected (using the "requirepass" configuration</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># directive below) it is possible to tell the replica to authenticate before</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># starting the replication synchronization process, otherwise the master will</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># refuse the replica request.</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># masterauth &lt;master-password></span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># 若主机有密码，需要配置主机密码</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># However this is not enough if you are using Redis ACLs (for Redis version</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># 6 or greater), and the default user is not capable of running the PSYNC</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># command and/or other commands needed for replication. In this case it's</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># better to configure a special user to use with replication, and specify the</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># masteruser configuration as such:</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># masteruser &lt;username></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># When masteruser is specified, the replica will authenticate against its</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># master using the new AUTH form: AUTH &lt;username> &lt;password>.</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># When a replica loses its connection with the master, or when the replication</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># is still in progress, the replica can act in two different ways:</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment"># 1) if replica-serve-stale-data is set to 'yes' (the default) the replica will</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">#    still reply to client requests, possibly with out of date data, or the</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">#    data set may just be empty if this is the first synchronization.</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment"># 2) If replica-serve-stale-data is set to 'no' the replica will reply with</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">#    an error "SYNC with master in progress" to all commands except:</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#    INFO, REPLICAOF, AUTH, PING, SHUTDOWN, REPLCONF, ROLE, CONFIG, SUBSCRIBE,</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">#    UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE, PUBLISH, PUBSUB, COMMAND, POST,</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">#    HOST and LATENCY.</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="57"></td><td><pre>replica-serve-stale-data <span class="token function">yes</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># You can configure a replica instance to accept writes or not. Writing against</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># a replica instance may be useful to store some ephemeral data (because data</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># written on a replica will be easily deleted after resync with the master) but</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment"># may also cause problems if clients are writing to it because of a</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment"># misconfiguration.</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment"># Since Redis 2.6 by default replicas are read-only.</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment"># Note: read only replicas are not designed to be exposed to untrusted clients</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># on the internet. It's just a protection layer against misuse of the instance.</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment"># Still a read only replica exports by default all the administrative commands</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment"># such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment"># security of read only replicas using 'rename-command' to shadow all the</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment"># administrative / dangerous commands.</span></pre></td></tr><tr><td data-num="73"></td><td><pre>replica-read-only <span class="token function">yes</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment"># Replication SYNC strategy: disk or socket.</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment"># New replicas and reconnecting replicas that are not able to continue the</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># replication process just receiving differences, need to do what is called a</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment"># "full synchronization". An RDB file is transmitted from the master to the</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment"># replicas.</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># The transmission can happen in two different ways:</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment"># 1) Disk-backed: The Redis master creates a new process that writes the RDB</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment">#                 file on disk. Later the file is transferred by the parent</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment">#                 process to the replicas incrementally.</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># 2) Diskless: The Redis master creates a new process that directly writes the</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment">#              RDB file to replica sockets, without touching the disk at all.</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># With disk-backed replication, while the RDB file is generated, more replicas</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment"># can be queued and served with the RDB file as soon as the current child</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># producing the RDB file finishes its work. With diskless replication instead</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment"># once the transfer starts, new replicas arriving will be queued and a new</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment"># transfer will start when the current one terminates.</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment"># When diskless replication is used, the master waits a configurable amount of</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># time (in seconds) before starting the transfer in the hope that multiple</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token comment"># replicas will arrive and the transfer can be parallelized.</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token comment"># With slow disks and fast (large bandwidth) networks, diskless replication</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token comment"># works better.</span></pre></td></tr><tr><td data-num="102"></td><td><pre>repl-diskless-sync no</pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment"># When diskless replication is enabled, it is possible to configure the delay</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment"># the server waits in order to spawn the child that transfers the RDB via socket</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment"># to the replicas.</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token comment"># This is important since once the transfer starts, it is not possible to serve</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token comment"># new replicas arriving, that will be queued for the next RDB transfer, so the</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token comment"># server waits a delay in order to let more replicas arrive.</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token comment"># The delay is specified in seconds, and by default is 5 seconds. To disable</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment"># it entirely just set it to 0 seconds and the transfer will start ASAP.</span></pre></td></tr><tr><td data-num="114"></td><td><pre>repl-diskless-sync-delay <span class="token number">5</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># -----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment"># WARNING: RDB diskless load is experimental. Since in this setup the replica</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token comment"># does not immediately store an RDB on disk, it may cause data loss during</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token comment"># failovers. RDB diskless load + Redis modules not handling I/O reads may also</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment"># cause Redis to abort in case of I/O errors during the initial synchronization</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment"># stage with the master. Use only if you know what you are doing.</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment"># -----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment"># Replica can load the RDB it reads from the replication link directly from the</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token comment"># socket, or store the RDB to a file and read that file after it was completely</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token comment"># received from the master.</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token comment"># In many cases the disk is slower than the network, and storing and loading</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token comment"># the RDB file may increase replication time (and even increase the master's</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment"># Copy on Write memory and salve buffers).</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token comment"># However, parsing the RDB file directly from the socket may mean that we have</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token comment"># to flush the contents of the current database before the full rdb was</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment"># received. For this reason we have the following options:</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token comment"># "disabled"    - Don't use diskless load (store the rdb file to the disk first)</span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment"># "on-empty-db" - Use diskless load only when it is completely safe.</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token comment"># "swapdb"      - Keep a copy of the current db contents in RAM while parsing</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token comment">#                 the data directly from the socket. note that this requires</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token comment">#                 sufficient memory, if you don't have it, you risk an OOM kill.</span></pre></td></tr><tr><td data-num="140"></td><td><pre>repl-diskless-load disabled</pre></td></tr><tr><td data-num="141"></td><td><pre></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token comment"># Replicas send PINGs to server in a predefined interval. It's possible to</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token comment"># change this interval with the repl_ping_replica_period option. The default</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token comment"># value is 10 seconds.</span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token comment"># repl-ping-replica-period 10</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token comment"># The following option sets the replication timeout for:</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token comment"># 1) Bulk transfer I/O during SYNC, from the point of view of replica.</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token comment"># 2) Master timeout from the point of view of replicas (data, pings).</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token comment"># 3) Replica timeout from the point of view of masters (REPLCONF ACK pings).</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token comment"># It is important to make sure that this value is greater than the value</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token comment"># specified for repl-ping-replica-period otherwise a timeout will be detected</span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token comment"># every time there is low traffic between the master and the replica. The default</span></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token comment"># value is 60 seconds.</span></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token comment"># repl-timeout 60</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token comment"># Disable TCP_NODELAY on the replica socket after SYNC?</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token comment"># If you select "yes" Redis will use a smaller number of TCP packets and</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token comment"># less bandwidth to send data to replicas. But this can add a delay for</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token comment"># the data to appear on the replica side, up to 40 milliseconds with</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token comment"># Linux kernels using a default configuration.</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token comment"># If you select "no" the delay for data to appear on the replica side will</span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token comment"># be reduced but more bandwidth will be used for replication.</span></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token comment"># By default we optimize for low latency, but in very high traffic conditions</span></pre></td></tr><tr><td data-num="172"></td><td><pre><span class="token comment"># or when the master and replicas are many hops away, turning this to "yes" may</span></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token comment"># be a good idea.</span></pre></td></tr><tr><td data-num="174"></td><td><pre>repl-disable-tcp-nodelay no</pre></td></tr><tr><td data-num="175"></td><td><pre></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token comment"># Set the replication backlog size. The backlog is a buffer that accumulates</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token comment"># replica data when replicas are disconnected for some time, so that when a</span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token comment"># replica wants to reconnect again, often a full resync is not needed, but a</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token comment"># partial resync is enough, just passing the portion of data the replica</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token comment"># missed while disconnected.</span></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token comment"># The bigger the replication backlog, the longer the replica can endure the</span></pre></td></tr><tr><td data-num="183"></td><td><pre><span class="token comment"># disconnect and later be able to perform a partial resynchronization.</span></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token comment"># The backlog is only allocated if there is at least one replica connected.</span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token comment"># repl-backlog-size 1mb</span></pre></td></tr><tr><td data-num="188"></td><td><pre></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token comment"># After a master has no connected replicas for some time, the backlog will be</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token comment"># freed. The following option configures the amount of seconds that need to</span></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token comment"># elapse, starting from the time the last replica disconnected, for the backlog</span></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token comment"># buffer to be freed.</span></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token comment"># Note that replicas never free the backlog for timeout, since they may be</span></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token comment"># promoted to masters later, and should be able to correctly "partially</span></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token comment"># resynchronize" with other replicas: hence they should always accumulate backlog.</span></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="198"></td><td><pre><span class="token comment"># A value of 0 means to never release the backlog.</span></pre></td></tr><tr><td data-num="199"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token comment"># repl-backlog-ttl 3600</span></pre></td></tr><tr><td data-num="201"></td><td><pre></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token comment"># The replica priority is an integer number published by Redis in the INFO</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token comment"># output. It is used by Redis Sentinel in order to select a replica to promote</span></pre></td></tr><tr><td data-num="204"></td><td><pre><span class="token comment"># into a master if the master is no longer working correctly.</span></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token comment"># A replica with a low priority number is considered better for promotion, so</span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token comment"># for instance if there are three replicas with priority 10, 100, 25 Sentinel</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token comment"># will pick the one with priority 10, that is the lowest.</span></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token comment"># However a special priority of 0 marks the replica as not able to perform the</span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token comment"># role of master, so a replica with priority of 0 will never be selected by</span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token comment"># Redis Sentinel for promotion.</span></pre></td></tr><tr><td data-num="213"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="214"></td><td><pre><span class="token comment"># By default the priority is 100.</span></pre></td></tr><tr><td data-num="215"></td><td><pre>replica-priority <span class="token number">100</span></pre></td></tr><tr><td data-num="216"></td><td><pre></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token comment"># -----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="218"></td><td><pre><span class="token comment"># By default, Redis Sentinel includes all replicas in its reports. A replica</span></pre></td></tr><tr><td data-num="219"></td><td><pre><span class="token comment"># can be excluded from Redis Sentinel's announcements. An unannounced replica</span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token comment"># will be ignored by the 'sentinel replicas &lt;master>' command and won't be</span></pre></td></tr><tr><td data-num="221"></td><td><pre><span class="token comment"># exposed to Redis Sentinel's clients.</span></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="223"></td><td><pre><span class="token comment"># This option does not change the behavior of replica-priority. Even with</span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token comment"># replica-announced set to 'no', the replica can be promoted to master. To</span></pre></td></tr><tr><td data-num="225"></td><td><pre><span class="token comment"># prevent this behavior, set replica-priority to 0.</span></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="227"></td><td><pre><span class="token comment"># replica-announced yes</span></pre></td></tr><tr><td data-num="228"></td><td><pre></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token comment"># It is possible for a master to stop accepting writes if there are less than</span></pre></td></tr><tr><td data-num="230"></td><td><pre><span class="token comment"># N replicas connected, having a lag less or equal than M seconds.</span></pre></td></tr><tr><td data-num="231"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token comment"># The N replicas need to be in "online" state.</span></pre></td></tr><tr><td data-num="233"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="234"></td><td><pre><span class="token comment"># The lag in seconds, that must be &lt;= the specified value, is calculated from</span></pre></td></tr><tr><td data-num="235"></td><td><pre><span class="token comment"># the last ping received from the replica, that is usually sent every second.</span></pre></td></tr><tr><td data-num="236"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="237"></td><td><pre><span class="token comment"># This option does not GUARANTEE that N replicas will accept the write, but</span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token comment"># will limit the window of exposure for lost writes in case not enough replicas</span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token comment"># are available, to the specified number of seconds.</span></pre></td></tr><tr><td data-num="240"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token comment"># For example to require at least 3 replicas with a lag &lt;= 10 seconds use:</span></pre></td></tr><tr><td data-num="242"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="243"></td><td><pre><span class="token comment"># min-replicas-to-write 3</span></pre></td></tr><tr><td data-num="244"></td><td><pre><span class="token comment"># min-replicas-max-lag 10</span></pre></td></tr><tr><td data-num="245"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="246"></td><td><pre><span class="token comment"># Setting one or the other to 0 disables the feature.</span></pre></td></tr><tr><td data-num="247"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="248"></td><td><pre><span class="token comment"># By default min-replicas-to-write is set to 0 (feature disabled) and</span></pre></td></tr><tr><td data-num="249"></td><td><pre><span class="token comment"># min-replicas-max-lag is set to 10.</span></pre></td></tr><tr><td data-num="250"></td><td><pre></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token comment"># A Redis master is able to list the address and port of the attached</span></pre></td></tr><tr><td data-num="252"></td><td><pre><span class="token comment"># replicas in different ways. For example the "INFO replication" section</span></pre></td></tr><tr><td data-num="253"></td><td><pre><span class="token comment"># offers this information, which is used, among other tools, by</span></pre></td></tr><tr><td data-num="254"></td><td><pre><span class="token comment"># Redis Sentinel in order to discover replica instances.</span></pre></td></tr><tr><td data-num="255"></td><td><pre><span class="token comment"># Another place where this info is available is in the output of the</span></pre></td></tr><tr><td data-num="256"></td><td><pre><span class="token comment"># "ROLE" command of a master.</span></pre></td></tr><tr><td data-num="257"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="258"></td><td><pre><span class="token comment"># The listed IP address and port normally reported by a replica is</span></pre></td></tr><tr><td data-num="259"></td><td><pre><span class="token comment"># obtained in the following way:</span></pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="261"></td><td><pre><span class="token comment">#   IP: The address is auto detected by checking the peer address</span></pre></td></tr><tr><td data-num="262"></td><td><pre><span class="token comment">#   of the socket used by the replica to connect with the master.</span></pre></td></tr><tr><td data-num="263"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="264"></td><td><pre><span class="token comment">#   Port: The port is communicated by the replica during the replication</span></pre></td></tr><tr><td data-num="265"></td><td><pre><span class="token comment">#   handshake, and is normally the port that the replica is using to</span></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token comment">#   listen for connections.</span></pre></td></tr><tr><td data-num="267"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="268"></td><td><pre><span class="token comment"># However when port forwarding or Network Address Translation (NAT) is</span></pre></td></tr><tr><td data-num="269"></td><td><pre><span class="token comment"># used, the replica may actually be reachable via different IP and port</span></pre></td></tr><tr><td data-num="270"></td><td><pre><span class="token comment"># pairs. The following two options can be used by a replica in order to</span></pre></td></tr><tr><td data-num="271"></td><td><pre><span class="token comment"># report to its master a specific set of IP and port, so that both INFO</span></pre></td></tr><tr><td data-num="272"></td><td><pre><span class="token comment"># and ROLE will report those values.</span></pre></td></tr><tr><td data-num="273"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="274"></td><td><pre><span class="token comment"># There is no need to use both the options if you need to override just</span></pre></td></tr><tr><td data-num="275"></td><td><pre><span class="token comment"># the port or the IP address.</span></pre></td></tr><tr><td data-num="276"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="277"></td><td><pre><span class="token comment"># replica-announce-ip 5.5.5.5</span></pre></td></tr><tr><td data-num="278"></td><td><pre><span class="token comment"># replica-announce-port 1234</span></pre></td></tr></table></figure><blockquote><p>细节</p></blockquote><p>主机可以写，从机不能写只能读！主机中的所有信息和数据，都会自动被从机保存！</p><p>主机断开连接，从机依旧连接到主机的，但是没有写操作，这个时候，主机如果回来了，从机依旧可以直接获取到主机写的信息！</p><blockquote><p>复制原理</p></blockquote><p>Slave 启动成功连接到 master 后会发送一个 sync 命令</p><p>Master 接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master 将传送整个数据文件到 slave，并完成一次完全同步。</p><p>全量复制：而 slave 服务在接收到数据库文件数据后，将其存盘并加载到内存中。</p><p>增量复制：Master 继续将新的所有收集到的修改命令依次传给 slave，完成同步</p><p>但是只要是重新连接 master，一次完全同步（全量复制) 将被自动执行</p><h3 id="哨兵模式重要"><a class="anchor" href="#哨兵模式重要">#</a> 哨兵模式 (重要)</h3><p>主从切换技术的方法是︰当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。Redis 从 2.8 开始正式提供了 Sentinel (哨兵）架构来解决这个问题。</p><p>哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例。哨兵能够后台监控主机是否故障，如果故障了根据投票数<mark>自动将从库转换为主库</mark>。</p><p><img data-src="/image-20210808173627454.png" alt="image-20210808173627454"></p><p>这里的哨兵有两个作用</p><ul><li>通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器。</li><li>当哨兵监测到 master 宕机，会自动将 slave 切换成 master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机。</li></ul><p>然而一个哨兵进程对 Redis 服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。</p><p><img data-src="/image-20210808180701079.png" alt="image-20210808180701079"></p><p>假设主服务器宕机，哨兵 1 先检测到这个结果，系统并不会马上进行 failover 过程，仅仅是哨兵 1 主观的认为主服务器不可用，这个现象成为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 failover [故障转移] 操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong>。</p><blockquote><p>配置哨兵</p></blockquote><ul><li><p>新建 <code>sentinel.conf</code></p></li><li><p>配置哨兵</p><ul><li>最少配置</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span> <span class="token comment"># Sentinel 去监视一个名为 mymaster 的主服务器， 这个主服务器的 IP 地址为 127.0.0.1 ， 端口号为 6379 ， 而将这个主服务器判断为失效至少需要 2 个 Sentinel 同意 （只要同意 Sentinel 的数量不达标，自动故障迁移就不会执行）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 注：哨兵只需要配置监视主服务器就可以了</span></pre></td></tr><tr><td data-num="3"></td><td><pre>sentinel down-after-milliseconds mymaster <span class="token number">60000</span> <span class="token comment"># Sentinel 认为服务器已经断线所需的毫秒数</span></pre></td></tr><tr><td data-num="4"></td><td><pre>sentinel failover-timeout mymaster <span class="token number">180000</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>sentinel parallel-syncs mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>sentinel monitor resque <span class="token number">192.168</span>.1.3 <span class="token number">6380</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="8"></td><td><pre>sentinel down-after-milliseconds resque <span class="token number">10000</span></pre></td></tr><tr><td data-num="9"></td><td><pre>sentinel failover-timeout resque <span class="token number">180000</span></pre></td></tr><tr><td data-num="10"></td><td><pre>sentinel parallel-syncs resque <span class="token number">5</span></pre></td></tr></table></figure><ul><li>通用配置</li></ul></li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Example sentinel.conf  </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 哨兵 sentinel 实例运行的端口 默认 26379  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>port <span class="token number">26379</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 哨兵 sentinel 的工作目录  </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">dir</span> /tmp  </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 哨兵 sentinel 监控的 redis 主节点的 ip port   </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># master-name  可以自己命名的主节点名字 只能由字母 A-z、数字 0-9 、这三个字符 ".-_" 组成。  </span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># quorum 当这些 quorum 个数 sentinel 哨兵认为 master 主节点失联 那么这时 客观上认为主节点失联了  </span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># sentinel monitor &lt;master-name> &lt;ip> &lt;redis-port> &lt;quorum>  </span></pre></td></tr><tr><td data-num="13"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 当在 Redis 实例中开启了 requirepass foobared 授权密码 这样所有连接 Redis 实例的客户端都要提供密码  </span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 设置哨兵 sentinel 连接主从的密码 注意必须为主从设置一样的验证密码  </span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># sentinel auth-pass &lt;master-name> &lt;password>  </span></pre></td></tr><tr><td data-num="18"></td><td><pre>sentinel auth-pass mymaster MySUPER--secret-0123passw0rd  </pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 指定多少毫秒之后 主节点没有应答哨兵 sentinel 此时 哨兵主观上认为主节点下线 默认 30 秒  </span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># sentinel down-after-milliseconds &lt;master-name> &lt;milliseconds>  </span></pre></td></tr><tr><td data-num="23"></td><td><pre>sentinel down-after-milliseconds mymaster <span class="token number">30000</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 这个配置项指定了在发生 failover 主备切换时最多可以有多少个 slave 同时对新的 master 进行 同步，  </span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 这个数字越小，完成 failover 所需的时间就越长，但是如果这个数字越大，就意味着越 多的 slave 因为 replication 而不可用。  </span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 可以通过将这个值设为 1 来保证每次只有一个 slave 处于不能处理命令请求的状态。  </span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># sentinel parallel-syncs &lt;master-name> &lt;numslaves>  </span></pre></td></tr><tr><td data-num="29"></td><td><pre>sentinel parallel-syncs mymaster <span class="token number">1</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面：   </span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">#1. 同一个 sentinel 对同一个 master 两次 failover 之间的间隔时间。  </span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">#2. 当一个 slave 从一个错误的 master 那里同步数据开始计算时间。直到 slave 被纠正为向正确的 master 那里同步数据时。  </span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#3. 当想要取消一个正在进行的 failover 所需要的时间。    </span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#4. 当进行 failover 时，配置所有 slaves 指向新的 master 所需的最大时间。不过，即使过了这个超时，slaves 依然会被正确配置为指向 master，但是就不按 parallel-syncs 所配置的规则来了  </span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># 默认三分钟  </span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># sentinel failover-timeout &lt;master-name> &lt;milliseconds>  </span></pre></td></tr><tr><td data-num="39"></td><td><pre>sentinel failover-timeout mymaster <span class="token number">180000</span>  </pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># SCRIPTS EXECUTION  </span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。  </span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">#对于脚本的运行结果有以下规则：  </span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">#若脚本执行后返回 1，那么该脚本稍后将会被再次执行，重复次数目前默认为 10  </span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">#若脚本执行后返回 2，或者比 2 更高的一个返回值，脚本将不会重复执行。  </span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为 1 时的行为相同。  </span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">#一个脚本的最大执行时间为 60s，如果超过这个时间，脚本将会被一个 SIGKILL 信号终止，之后重新执行。  </span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">#通知型脚本：当 sentinel 有任何警告级别的事件发生时（比如说 redis 实例的主观失效和客观失效等等），将会去调用这个脚本，  </span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment"># 这时这个脚本应该通过邮件，SMS 等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，一个是事件的类型，一个是事件的描述。  </span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment"># 如果 sentinel.conf 配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则 sentinel 无法正常启动成功。  </span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#通知脚本  </span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment"># sentinel notification-script &lt;master-name> &lt;script-path>  </span></pre></td></tr><tr><td data-num="55"></td><td><pre>sentinel notification-script mymaster /var/redis/notify.sh  </pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment"># 客户端重新配置主节点参数脚本  </span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment"># 当一个 master 由于 failover 而发生改变时，这个脚本将会被调用，通知相关的客户端关于 master 地址已经发生改变的信息。  </span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># 以下参数将会在调用脚本时传给脚本:  </span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># &lt;master-name> &lt;role> &lt;state> &lt;from-ip> &lt;from-port> &lt;to-ip> &lt;to-port>  </span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># 目前 & lt;state > 总是 “failover”,  </span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment"># &lt;role > 是 “leader” 或者 “observer” 中的一个。   </span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment"># 参数 from-ip, from-port, to-ip, to-port 是用来和旧的 master 和新的 master (即旧的 slave) 通信的  </span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的。  </span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment"># sentinel client-reconfig-script &lt;master-name> &lt;script-path>  </span></pre></td></tr><tr><td data-num="66"></td><td><pre>sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</pre></td></tr></table></figure><ul><li><p>启动哨兵</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>redis-sentinel /path/to/sentinel.conf <span class="token comment"># 通过配置文件启动哨兵</span></pre></td></tr><tr><td data-num="2"></td><td><pre>redis-server /path/to/sentinel.conf --sentinel <span class="token comment"># 启动一个运行在 Sentinel 模式下的 Redis 服务器</span></pre></td></tr></table></figure></li></ul><blockquote><p>哨兵模式规则</p></blockquote><p>当主机掉线时，哨兵会选取一个从机使其变为主机，</p><p>而主机恢复后只能归并到新的主机下当从机</p><blockquote><p>优缺点</p></blockquote><p>优点:</p><ol><li>哨兵集群，基于主从复制模式，所有的主从配置优点，它全有</li><li>主从可以切换，故障可以转移，系统的可用性就会更好</li><li>哨兵模式就是主从模式的升级，手动到自动，更加健壮！</li></ol><p>缺点︰</p><ol><li>Redis 不好啊在线扩容的，集群容量一旦到达上限，在线扩容就十分麻烦！</li><li>实现哨兵模式的配置其实是很麻烦的，里面有很多选择！</li></ol><h2 id="redis缓存穿透和雪崩"><a class="anchor" href="#redis缓存穿透和雪崩">#</a> Redis 缓存穿透和雪崩</h2><p>Redis 缓存的使用，极大的提升了应用程序的性能和效率，特别是数据查询方面。但同时，它也带来了一些问题。其中，最要害的问题，就是数据的一致性问题，从严格意义上讲，这个问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。<br>另外的一些典型问题就是，缓存穿透、缓存雪崩和缓存击穿。目前，业界也都有比较流行的解决方案。</p><h3 id="缓存穿透"><a class="anchor" href="#缓存穿透">#</a> 缓存穿透</h3><blockquote><p>概念</p></blockquote><p>缓存穿透的概念很简单，用户想要查询一个数据，发现 redis 内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中，于是都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。</p><blockquote><p>解决方案</p></blockquote><p><strong>布隆过滤器</strong></p><p>布隆过滤器是一种数据结构，对所有可能查询的参数以 hash 形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的查询压力；</p><p><img data-src="/image-20210808190018406.png" alt="image-20210808190018406"></p><p><strong>缓存空对象</strong></p><p>当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将会从缓存中获取，保护了后端数据源；</p><p><img data-src="/image-20210808190056849.png" alt="image-20210808190056849"></p><p>但是这种方法会存在两个问题:</p><ol><li>如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键；</li><li>即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致，这对于需要保持一致性的业务会有影响。</li></ol><h3 id="缓存击穿"><a class="anchor" href="#缓存击穿">#</a> 缓存击穿</h3><blockquote><p>概念</p></blockquote><p>这里需要注意和缓存击穿的区别，缓存击穿，是指一个 key 非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个 key 在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞<br>当某个 key 在过期的瞬间，有大量的请求并发访问，这类数据一般是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并且回写缓存，会导使数据库瞬间压力过大。</p><blockquote><p>解决方案</p></blockquote><p><strong>设置热点数据永不过期</strong></p><p>从缓存层面来看，没有设置过期时间，所以不会出现热点 key 过期后产生的问题。</p><p><strong>加互斥锁</strong></p><p>分布式锁∶使用分布式锁，保证对于每个 key 同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。</p><h3 id="缓存雪崩"><a class="anchor" href="#缓存雪崩">#</a> 缓存雪崩</h3><blockquote><p>概念</p></blockquote><p>缓存雪崩，是指在某一个时间段，缓存集中过期失效。</p><p>产生雪崩的原因之一，比如在写本文的时候，马上就要到双十二零点，很快就会迎来一波抢购，这波商品时间比较集中的放入了缓存，假设缓存一个小时。那么到了凌晨一点钟的时候，这批商品的缓存就都过期了。而对这批商品的访问查询，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。于是所有的请求都会达到存储层，存储层的调用量会暴增，造成存储层也会挂掉的情况。</p><p><img data-src="/image-20210808190455174.png" alt="image-20210808190455174"></p><p>其实集中过期，倒不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候，数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮。</p><blockquote><p>解决方案</p></blockquote><p><strong>redis 高可用</strong></p><p>这个思想的含义是，既然 redis 有可能挂掉，那我多增设几台 redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群。（异地多活！)</p><p><strong>限流降级</strong></p><p>这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待。</p><p><strong>数据预热</strong></p><p>数据加热的含义就是在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀。</p><h2 id="分布式锁"><a class="anchor" href="#分布式锁">#</a> 分布式锁</h2><p>分布式锁在很多场景中是非常有用的原语， 不同的进程必须以独占资源的方式实现资源共享就是一个典型的例子。</p><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMTEzNTQwNjU=">细说 Redis 分布式锁</span></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-08-09 09:44:30" itemprop="dateModified" datetime="2021-08-09T09:44:30+08:00">2021-08-09</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Ling yunchi 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Ling yunchi 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Ling yunchi 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Ling yunchi <i class="ic i-at"><em>@</em></i>QWQ</li><li class="link"><strong>本文链接：</strong> <a href="https://ling-yunchi.github.io/2021/08/06/Redis/" title="Redis">https://ling-yunchi.github.io/2021/08/06/Redis/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/08/02/javaWeb/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeyhsblkj20zk0m81kx.jpg" title="javaWeb"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>javaWeb</h3></a></div><div class="item right"><a href="/2021/08/09/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicljitigmj20zk0m87fp.jpg" title="JUC并发编程"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>JUC并发编程</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nosql"><span class="toc-number">1.1.</span> <span class="toc-text">Nosql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8nosql"><span class="toc-number">1.1.1.</span> <span class="toc-text">为什么要用 Nosql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFnosql"><span class="toc-number">1.1.2.</span> <span class="toc-text">什么是 NoSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nosql%E7%9A%84%E5%9B%9B%E5%A4%A7%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text">NoSQL 的四大分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Redis 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.1.</span> <span class="toc-text">redis 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%90%AF%E5%8A%A8%E4%B8%8E%E9%93%BE%E6%8E%A5%E4%B8%8E%E5%81%9C%E6%AD%A2"><span class="toc-number">1.2.2.</span> <span class="toc-text">redis 启动与链接与停止</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%80%A7%E8%83%BD"><span class="toc-number">1.2.3.</span> <span class="toc-text">测试性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.4.</span> <span class="toc-text">基础知识</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">五大数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-key"><span class="toc-number">1.3.1.</span> <span class="toc-text">Redis-Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#string"><span class="toc-number">1.3.2.</span> <span class="toc-text">String</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list"><span class="toc-number">1.3.3.</span> <span class="toc-text">List</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-number">1.3.4.</span> <span class="toc-text">Set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-number">1.3.5.</span> <span class="toc-text">Hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zset"><span class="toc-number">1.3.6.</span> <span class="toc-text">Zset</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">三种特殊数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#geospatial"><span class="toc-number">1.4.1.</span> <span class="toc-text">geospatial</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hyperloglog"><span class="toc-number">1.4.2.</span> <span class="toc-text">hyperloglog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmaps"><span class="toc-number">1.4.3.</span> <span class="toc-text">bitmaps</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">Redis 事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E8%A7%86"><span class="toc-number">1.5.1.</span> <span class="toc-text">监视</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jedis"><span class="toc-number">1.6.</span> <span class="toc-text">Jedis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.6.2.</span> <span class="toc-text">事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springboot%E6%95%B4%E5%90%88"><span class="toc-number">1.7.</span> <span class="toc-text">springboot 整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.7.1.</span> <span class="toc-text">自定义序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.7.2.</span> <span class="toc-text">Redis 工具类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redisconfig%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.8.</span> <span class="toc-text">Redis.config 详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.9.</span> <span class="toc-text">Redis 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rdbredis-database"><span class="toc-number">1.9.1.</span> <span class="toc-text">RDB(Redis Database)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aofappend-only-file"><span class="toc-number">1.9.2.</span> <span class="toc-text">AOF(Append Only File)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.9.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-number">1.10.</span> <span class="toc-text">Redis 发布订阅</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.11.</span> <span class="toc-text">Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.11.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">1.11.2.</span> <span class="toc-text">配置环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E9%87%8D%E8%A6%81"><span class="toc-number">1.11.3.</span> <span class="toc-text">哨兵模式 (重要)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9"><span class="toc-number">1.12.</span> <span class="toc-text">Redis 缓存穿透和雪崩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">1.12.1.</span> <span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">1.12.2.</span> <span class="toc-text">缓存击穿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">1.12.3.</span> <span class="toc-text">缓存雪崩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.13.</span> <span class="toc-text">分布式锁</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Ling yunchi" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Ling yunchi</p><div class="description" itemprop="description">qwqqqq</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">39</span> <span class="name">文章</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0xpbmcteXVuY2hp" title="https:&#x2F;&#x2F;github.com&#x2F;Ling-yunchi"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/08/02/javaWeb/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/08/09/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Ling yunchi @ Ling Yunchi</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/08/06/Redis/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->